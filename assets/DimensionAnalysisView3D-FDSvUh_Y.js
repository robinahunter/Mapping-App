import{fy as Hr,U as zr,tG as Vr,tH as Ir,bY as Gr,tI as kr,cC as Ut,gD as _t,cH as ne,cI as g,tJ as Fr,tK as Nr,ex as L,jG as b,tL as jr,mB as vi,nd as Si,ey as wi,fF as D,cF as me,oN as R,mI as Vn,jE as at,cG as is,ez as In,gC as k,tM as nt,tN as Pi,g4 as Ae,oO as Bt,e as p,y as f,c as z,g as K,tO as on,c8 as re,Z as S,av as F,f3 as qr,aX as Gn,af as X,tP as ss,mY as Ur,m$ as rs,m_ as as,jF as Ve,fG as Mt,tQ as Ce,ls as Wr,P as ot,tR as Zr,g1 as fe,gk as En,jD as P,tS as Br,nM as os,jH as ls,jx as x,jC as ge,kf as q,b3 as it,qf as Be,qb as I,jA as ke,qg as On,ca as Yr,cb as He,cc as xi,qk as kn,kj as Xr,tT as Qr,gH as Kr,kP as cs,mQ as fn,tU as st,jz as St,cd as us,gI as bi,tV as Jr,qe as ea,tW as ta,tX as na,tY as ia,cf as Cn,tZ as Ke,fH as Fn,kH as sa,kG as ve,kR as $i,lT as mn,gd as ds,lS as Dt,m3 as B,kX as ps,gL as Se,by as hs,mK as Yt,au as ra,c2 as Nn,t_ as aa,lc as oa,t$ as la,c7 as ca,lX as fs,jt as gn,fg as Mi,u0 as ua,q6 as Ei,g9 as da,oo as Oi,Y as Et,q8 as wt,q9 as Ot,qa as yt,u1 as Tn,u2 as pa,ql as ms,qj as ha,u3 as fa,u4 as ma,u5 as ga,u6 as Ci,u7 as Dn,m2 as gs,m4 as _n,lV as _a,u8 as Ti,u9 as ya,ua as _s,k as va,aH as Sa,ub as wa,uc as Ie,ud as Pa,ue as xa,os as ba,uf as $a,ug as Ma,lv as Ea,cM as Wt,uh as yn,h as ys,ui as Oa,eB as Ca,O as vn,br as Ta,id as Da,_ as Rt,uj as Ra,q1 as vs,bp as La,$ as Pt,cP as Di,dN as Aa,c0 as Ha,aw as jn,uk as za,cL as Ss,mR as ws,b$ as xt,jh as qn,lw as Rn,c4 as Ps,lR as xs,ul as Xt,u as Un,V as Wn,um as Ln,kV as Va,iL as Ia,un as Ga,uo as ka,i1 as Fa,up as bs,kN as Na,kO as ja,uq as qa,ur as ht,us as Ua,ut as Wa}from"./index-3T8NnAdH.js";import{b as $s,u as qe,s as Za,r as Ba,a as Ya}from"./LineVisualElement-mrWDSgVw.js";import{t as E,r as Xa,u as Qa}from"./LengthDimension-Tri9o4Jy.js";import{m as Ye,e as Ka,f as Ja,u as V,g as eo,h as to}from"./Segment-TeMlAb70.js";import{i as no,f as Ms}from"./unitFormatUtils-zKY0g_di.js";import{$ as ln,w as io,e as _e,D as Es,d as Ct,M as Zn,O as Lt,R as Bn,F as so,U as Os,j as Ri,a as ro,b as ao,v as oo,l as lo}from"./ShadedColorMaterial.glsl-bM-6avW0.js";import{F as co,H as Cs,A as Yn,l as uo}from"./Factory-qnF1klF8.js";import{g as Ts}from"./ImageMaterial.glsl-4yDSHPsM.js";import{c as po,y as C,Z as Ds,d as ho}from"./elevationInfoUtils-WwYDl0RG.js";import{r as Qt,t as Rs}from"./vec4f32-NvfHy9q7.js";import{t as Ls,z as fo}from"./RightAngleQuadVisualElement-qdXyiV5z.js";import{c as mo,x as Li}from"./Laserlines.glsl-Wb-z-XSI.js";import{l as H,v as go,L as Sn,m as _o,V as yo,p as vo,w as So}from"./EditGeometryOperations-DjI-3zXJ.js";import{o as wo}from"./floorFilterUtils-zOdaZIyV.js";import{r as Po}from"./dehydratedFeatureComparison-TL8HUJB8.js";function xo(n){const e=Hr(n),t=e===Vr?Ir:e;return zr(n,t)?t:n}var rt;function bo(n,e){const{spatialReference:t}=n;return Gr(t,e.spatialReference)?(At[0]=n.x,At[1]=n.y,At[2]=n.hasZ?n.z:0,Ht[0]=e.x,Ht[1]=e.y,Ht[2]=e.hasZ?e.z:0,As(At,Ht,t)):null}function As(n,e,t){const i=$o(n,e,t,rt.Direct);return i!=null?no(i.direct,i.unit):null}function $o(n,e,t,i){const s=xo(t),r=kr(s);if(r==null)return null;const a=e[2]-n[2];if(i===rt.Vertical)return{verticalSigned:a,unit:r};if(!Ut(n,t,wn,s)||!Ut(e,t,zt,s))return null;if(i===rt.Direct)return{direct:_t(zt,wn),unit:r};if(ne(Vt,n[0],n[1],e[2]),!Ut(Vt,t,Vt,s))return null;const l=_t(Vt,zt);return i===rt.Horizontal?{horizontal:l,unit:r}:{direct:_t(zt,wn),horizontal:l,vertical:Math.abs(a),unit:r}}(function(n){n[n.Direct=0]="Direct",n[n.Horizontal=1]="Horizontal",n[n.Vertical=2]="Vertical"})(rt||(rt={}));const At=g(),Ht=g(),wn=g(),zt=g(),Vt=g();function Mo(n,e,t){if(n==null)return null;const i=n.dimensionSegment.startRenderSpace,s=n.dimensionSegment.endRenderSpace,r=As(i,s,n.spatialReference);if(r==null)return null;const a=e===E.Vertical?Fr(r.value,r.unit,t):Nr(r.value,r.unit,t);return Ms(r,a)}function Kt(n){const{elevationAlignedStartPoint:e,elevationAlignedEndPoint:t,dimension:{offset:i,measureType:s,orientation:r}}=n;return{elevationAlignedStartPoint:e,elevationAlignedEndPoint:t,offset:i,measureType:s,orientation:r}}function Jt({elevationAlignedStartPoint:n,elevationAlignedEndPoint:e,offset:t,measureType:i,orientation:s},r,a=null){if(n==null||e==null)return null;const l=zs(a!=null?a.directSegment:new Ye,{elevationAlignedStartPoint:n,elevationAlignedEndPoint:e},r),o=a!=null?a.primaryOffsetAxis:g();cn(o,{measureType:i,elevationAlignedStartPoint:n,elevationAlignedEndPoint:e,directSegment:l,orientation:s,renderCoordsHelper:r});const c=a!=null?a.dimensionSegment:new Ye;return Xn({elevationAlignedStartPoint:n,elevationAlignedEndPoint:e})&&i===E.Vertical?(L(c.startRenderSpace,l.startRenderSpace),L(c.endRenderSpace,l.endRenderSpace)):Vs(c,{offsetAxis:o,offset:t,relativeToSegment:l,renderCoordsHelper:r}),{directSegment:l,dimensionSegment:c,primaryOffsetAxis:o,spatialReference:r.spatialReference}}function Ai(n,e,t,i){return e===bt.Start?(L(n.startRenderSpace,t.startRenderSpace),L(n.endRenderSpace,i.startRenderSpace)):(L(n.startRenderSpace,t.endRenderSpace),L(n.endRenderSpace,i.endRenderSpace)),n}var bt;function Eo(n,e,t,i){k(n.startRenderSpace,e.startRenderSpace,t,i),k(n.endRenderSpace,e.endRenderSpace,t,i)}function Hs(n,e,t,i){switch(e){case E.Direct:return zs(n,t,i);case E.Horizontal:case E.Vertical:{const{elevationAlignedStartPoint:s,elevationAlignedEndPoint:r,dimension:a,geometry:l}=t;let o;a.measureType===E.Direct?(o=Oo(l,i)===s.z>r.z,e===E.Horizontal&&(o=!o)):o=!Co(l);const[c,u]=o?[s,r]:[r,s],d=nt(u,To);return e===E.Horizontal?d.z=c.z:(d.x=c.x,d.y=c.y),i.toRenderCoords(c,n.startRenderSpace),i.toRenderCoords(d,n.endRenderSpace),n}}}function zs(n,e,t){return t.toRenderCoords(e.elevationAlignedStartPoint,n.startRenderSpace),t.toRenderCoords(e.elevationAlignedEndPoint,n.endRenderSpace),n}function Oo(n,e){const t=n.directSegment.eval(.5,b.get()),i=e.worldUpAtPosition(t,b.get()),s=n.dimensionSegment.eval(.5,b.get()),r=D(b.get(),s,t);return!Vn(r,at)&&R(r,i)>0}function Co(n){const{startRenderSpace:e,endRenderSpace:t}=n.dimensionSegment,{startRenderSpace:i,endRenderSpace:s}=n.directSegment;return Pi(i,e)<Pi(s,t)}(function(n){n[n.Start=0]="Start",n[n.End=1]="End"})(bt||(bt={}));const To=Ae(0,0,0,null);function Do(n,e,t,i){const{directSegment:s}=t,r=cn(b.get(),{measureType:e,directSegment:s,renderCoordsHelper:i}),a=Vs(Ro,{offsetAxis:r,offset:0,relativeToSegment:s,renderCoordsHelper:i}).eval(.5,b.get()),l=D(b.get(),n,a);return R(l,r)*i.unitInMeters}const Ro=new Ye;function cn(n,e){const{measureType:t,elevationAlignedStartPoint:i,elevationAlignedEndPoint:s,directSegment:{startRenderSpace:r,endRenderSpace:a},directSegment:l,renderCoordsHelper:o}=e,c=l.eval(.5,b.get()),u=o.worldUpAtPosition(c,b.get()),d=o.worldBasisAtPosition(c,jr.Y,b.get());switch(t){case E.Horizontal:L(n,u);break;case E.Vertical:R(r,u)<R(a,u)?D(n,a,r):D(n,r,a),me(n,n,u),me(n,n,u);break;case E.Direct:{const h=e.orientation??0;if(Xn({elevationAlignedStartPoint:i,elevationAlignedEndPoint:s}))vi(It,-Si(h),u),wi(n,d,It);else{const m=D(b.get(),a,r),_=me(b.get(),m,u);me(_,_,m),vi(It,Si(h),m),wi(n,_,It)}break}}return Vn(n,at)?L(n,d):is(n,n)}const It=In();function Xn({elevationAlignedStartPoint:n,elevationAlignedEndPoint:e}){return n!=null&&e!=null&&n.x===e.x&&n.y===e.y}function Vs(n,e){const{offsetAxis:t,offset:i,relativeToSegment:{startRenderSpace:s,endRenderSpace:r},relativeToSegment:a,renderCoordsHelper:l}=e,o=i/l.unitInMeters,[c,u]=Lo(s,r,t,o);return k(n.startRenderSpace,a.startRenderSpace,t,c),k(n.endRenderSpace,a.endRenderSpace,t,u),n}function Lo(n,e,t,i=0){const s=R(e,t),r=R(n,t),a=Math.abs(s-r)+i;return s>r?[a,i]:[i,a]}function un(n,e,t){const i=e.directSegment.eval(.5,b.get());return t.worldUpAtPosition(i,n)}function Qn(n,e){const{startRenderSpace:t,endRenderSpace:i}=e.directSegment;return D(n,i,t)}function Kn(n,e,t={invert:!1}){const{startRenderSpace:i,endRenderSpace:s}=e.dimensionSegment;return t.invert?D(n,i,s):D(n,s,i)}function An(n,e){const t=n.directSegment.eval(.5,b.get());return e.headingAtPosition(t,n.primaryOffsetAxis)}function Ao(n,e){return Bt(Kn(Ho,n))/e**2}const Ho=g();function Is(n){const{elevationAlignedStartPoint:e,elevationAlignedEndPoint:t}=n;if(e==null||t==null)return!1;const i=bo(e,t);return i!=null&&Ms(i,"meters").value>Gs}const Gs=1e5;function $t(n){return n.geometry!=null}let Ue=class extends K{constructor(e){super(e)}initialize(){const e=on(()=>this.analysisViewData.computations,({computation:t})=>this._watchComputation(t));this.addHandles(re(e))}get analysis(){return this.analysisViewData.analysis}get _defaultUnit(){return Ka(this.view)}_watchComputation(e){return S(()=>Kt(e),t=>{const{measureType:i}=t;if(Is(t)&&i!==E.Direct){const r=Math.round(qr(Gs,"meters","kilometers"));return Gn.getLogger(this).warnOnce(`A ${i} dimension in the analysis (id: '${this.analysis.id}') will not display, because only direct dimensions can measure lengths greater than ${r} km. Update the measureType of the affected dimension to "direct" to display it.`),void(e.geometry=null)}const s=Jt(t,this.view.renderCoordsHelper,e.geometry);e.geometry=s,e.result.length=Mo(s,i,this._defaultUnit)},F)}};p([f({constructOnly:!0})],Ue.prototype,"analysisViewData",void 0),p([f({constructOnly:!0})],Ue.prototype,"view",void 0),p([f()],Ue.prototype,"analysis",null),p([f()],Ue.prototype,"_defaultUnit",null),Ue=p([z("esri.views.3d.analysis.Dimension.support.DimensionController")],Ue);function en(n){return ss(n.accentColor,.5)}function zo(n){return Ur(n.accentColor)}const ks=5,Vo=new X([127,127,127,.5]),Fs=.8,Io=4,Go=6,ko=.1,Ns=.5,Fo=18,No=2,jo=.3,qo=2,Uo=.25,Wo=20,Zo=5,Hi=5,zi=10,Bo=2500,Yo=50,Xo=2;class Qo{constructor(e){this.start=e.start,this.end=e.end,this.offset=e.offset,this.heading=e.heading,this.rotation=e.rotation,this.direct=e.direct,this.horizontal=e.horizontal,this.vertical=e.vertical}manipulatorName(e){return Object.keys(this).find(t=>this.hasOwnProperty(t)&&e===this[t])}values(){return[this.start,this.end,this.offset,this.heading,this.rotation,this.direct,this.horizontal,this.vertical]}forEachMeasureTypeManipulator(e){for(const t of Xa)e(this.manipulatorForMeasureType(t),t)}manipulatorForMeasureType(e){switch(e){case E.Direct:return this.direct;case E.Horizontal:return this.horizontal;case E.Vertical:return this.vertical}}}class Ko extends ln{constructor(e,t){const i=io(X.toUnitRGBA(en(e.effectiveTheme))),s=[new _e(as(i,1,32,32),Te)];super({view:e,renderObjects:s,metadata:t.metadata,available:!1,grabCursor:"crosshair",radius:ks,collisionPriority:1}),this._themeHandle=S(()=>({color:X.toUnitRGBA(en(e.effectiveTheme))}),r=>i.setParameters(r))}destroy(){this._themeHandle.remove(),super.destroy()}}function Jo(n,e){const t=[q(-.5,0,0),q(.5,0,0)],i=Ve(e.unfocusedMaterial,t.map(r=>Mt(g(),r,Ns))),s=i.instantiate({material:e.focusedMaterial});return new ln({view:n,renderObjects:[new _e(i,Ce.Unfocused|Ce.Selected|Te),new _e(s,Ce.Focused|Te)],collisionType:{type:"line",paths:[t]},radius:Jn(e.lineSizePt)/2,metadata:e.metadata,available:!1,...Es})}class Vi extends ln{constructor(e,{lineSizePt:t,material:i,metadata:s}){super({view:e,autoScaleRenderObjects:!1,collisionPriority:1,metadata:s}),this._options={calloutColor:Wr(),lineSizePt:t,material:i},this._themeHandle=S(()=>X.toUnitRGBA(en(e.effectiveTheme)),r=>{this._options.calloutColor=r,Gi(this,Ii({...this._options,metadata:this.metadata}))},ot)}update({lineSizePt:e,material:t}){this._options.lineSizePt=e,this._options.material=t,Gi(this,Ii({...this._options,metadata:this.metadata}))}destroy(){this._themeHandle.remove(),super.destroy()}}function Ii({calloutColor:n,lineSizePt:e,material:t,metadata:i}){return{calloutLength:.25*Zr*Fs*fe(e)+Fo,calloutColor:n,calloutWidth:No,customStateMask:Te,discScale:jo,focusMultiplier:qo,material:t,metadata:i}}function el(n,e){const t=[q(-.5,0,0),q(.5,0,0)],i=Ve(e.thinOffsetManipulatorMaterial,t),s=Ve(e.unfocusedMaterial,t.map(a=>Mt(g(),a,Ns))),r=s.instantiate({material:e.focusedMaterial});return new ln({view:n,renderObjects:[new _e(s,Ce.Unfocused|Te),new _e(r,Ce.Focused|Te),new _e(i,Te)],collisionType:{type:"line",paths:[t]},radius:Jn(e.lineSizePt)/2,available:!1,metadata:e.metadata,...Es})}function tl(n,{isStart:e,createSnappingPipelineStep:t,dimension:i,onUpdate:s,view:r}){const a=e?"startPoint":"endPoint";return[Ct(n,(o,c,u,d)=>{const h=Yn(o),{snappingStep:m,cancelSnapping:_}=t(d);u=u.next(h).next(Bn(i,[a,"measureType","orientation"])).next(_),c.next(h).next(co(r)).next(...m).next(v=>{const y=nt(v.mapEnd,new it);s(a==="startPoint"?{startPoint:y}:{endPoint:y})})})]}function nl(n,{computation:e,view:t}){return[Ct(n,(i,s,r)=>{if(!$t(e)||!i.selected)return;const{geometry:a,dimension:l}=e,o=Yn(i);s.next(o).next(qs(t,l,a.dimensionSegment,a.primaryOffsetAxis)),r.next(o).next(Bn(l,["offset"]))})]}function il(n,{computation:e,view:t}){return[Ct(n,(i,s,r)=>{js({cancel:r,computation:e,settingHeading:!0,steps:s,view:t})})]}function sl(n,{computation:e,view:t}){return[Ct(n,(i,s,r)=>{js({cancel:r,computation:e,settingHeading:!1,steps:s,view:t})}),n.events.on("immediate-click",i=>{rl(i,e,t)})]}function rl(n,e,t){const{dimension:i,geometry:s}=e;if(i.orientation===90||i.orientation===270)return i.orientation=0,void n.stopPropagation();if(s==null)return;const{renderCoordsHelper:r}=t,a=Jt({...Kt(e),orientation:90},r),l=Jt({...Kt(e),orientation:270},r);if(a==null||l==null)return;const o=An(a,r),c=An(l,r),u=Us(s,t),d=En.shortestSignedDiff(u,o),h=En.shortestSignedDiff(u,c);i.orientation=Math.abs(d)<Math.abs(h)?90:270,n.stopPropagation()}function js(n){const{cancel:e,computation:t,settingHeading:i,steps:s,view:r}=n;if(!$t(t))return;const{renderCoordsHelper:a}=r,{dimension:l,geometry:o}=t,c=g(),u=Zs(g(),o,o.directSegment,a),d=Bs(b.get(),{forHeading:i,geometry:o,renderCoordsHelper:a}),h=Be(u,d,I()),m=i?l.orientation??An(o,r.renderCoordsHelper):l.orientation??0;s.next(Cs(r,h)).next(_=>{_.action==="start"&&L(c,_.renderStart);const v=kn(h),y=so(c,_.renderEnd,u,v);let w=m-Xr(y);i||(w=al(w)),l.orientation=w}),e.next(Bn(l,["orientation"]))}function al(n){const e=En.normalize(n)%90;return e<Hi?n-e:90-e<Hi?n+(90-e):n}function ol(n,{computation:e,manipulatorMeasureType:t,view:i}){let s=E.Direct,r=0,a=0;return[n.events.on("grab-changed",l=>{if(l.action!=="start"||!$t(e))return;const{dimension:o,geometry:c}=e;s=o.measureType,r=o.offset,a=o.orientation;const u=L(b.get(),n.renderLocation);o.measureType=t,o.offset=Do(u,t,c,i.renderCoordsHelper),o.orientation=0}),Ct(n,(l,o,c)=>{if(!$t(e))return;const{geometry:u,dimension:d}=e,{renderCoordsHelper:h}=i,m=Hs(Ys,t,e,h),_=cn(b.get(),{measureType:t,directSegment:u.directSegment,renderCoordsHelper:h}),v=Yn(l);o.next(v).next(qs(i,d,m,_)),c.next(v).next(y=>(d.measureType=s,d.offset=r,d.orientation=a,y))})]}function qs(n,e,t,i){const s=ke(b.get(),t.endRenderSpace,t.startRenderSpace);me(s,s,i);const r=Be(t.startRenderSpace,s,I()),a=Be(t.startRenderSpace,i,I()),l=e.offset;let o,c=0;const u=new Os;return u.next(Cs(n,r)).next(d=>{d.action==="start"&&(c=On(a,d.renderStart));const h=(On(a,d.renderEnd)-c)*n.renderCoordsHelper.unitInMeters;e.offset=l+h,o=d}),d=>(u.execute(d),o)}function Us(n,e){const{directSegment:t}=n,{renderCoordsHelper:i}=e,s=un(b.get(),n,i),r=Qn(b.get(),n),a=me(b.get(),r,s),{viewForward:l}=e.state.camera;R(a,l)>0&&Mt(a,a,-1);const o=t.eval(.5,b.get());return i.headingAtPosition(o,a)}function ll(n,e,t){const{dimensionSegment:i,primaryOffsetAxis:s}=e,r=Kn(vt,e),a=P(r,at)?Br(tn):Zn(r,s,at,tn),l=Math.max(os(r),ko/t.unitInMeters);ls(a,a,ne(vt,l,l,l)),n.modelTransform=a,n.renderLocation=i.eval(.5,vt)}function cl(n,e,t){Ws(n,e,t,{forHeading:!0})}function ul(n,e,t){Ws(n,e,t,{forHeading:!1})}function Ws(n,e,t,{forHeading:i}){const{dimension:s,geometry:r}=e,{primaryOffsetAxis:a}=r,l=Mt(dl,a,s.offset>=0?1:-1),o=Bs(pl,{forHeading:i,geometry:r,renderCoordsHelper:t});me(o,o,l);const c=Zn(l,o,at,tn);n.modelTransform=c,n.renderLocation=Zs(vt,r,r.dimensionSegment,t)}const dl=g(),pl=g();function hl(n,e,t,i){const{geometry:s}=e,r=Hs(Ys,t,e,i),a=cn(vt,{measureType:t,directSegment:s.directSegment,renderCoordsHelper:i}),l=D(Pn,r.endRenderSpace,r.startRenderSpace),o=Zn(l,a,at,tn),c=os(l);ls(o,o,ne(Pn,c,c,c)),n.modelTransform=o,n.renderLocation=r.eval(.5,Pn)}function Zs(n,e,t,i){const{startRenderSpace:s,endRenderSpace:r}=t,a=fl(e,i)?s:r;return L(n,a)}function Bs(n,{forHeading:e,geometry:t,renderCoordsHelper:i}){return e?un(n,t,i):Kn(n,t,{invert:!0})}function fl(n,e){const t=Qn(ml,n),i=un(gl,n,e);return R(t,i)>0}const ml=g(),gl=g();function _l(n){return fe(n)+Io}function Jn(n){return fe(n)+Go}function Gi(n,e){var m;const t=e.material??new Ts({transparent:!0,writeDepth:!1,textureId:(m=e.texture)==null?void 0:m.id,renderOccluded:x.Opaque,isDecoration:!0}),i=e.focusMultiplier??Lt.focusMultiplier,s=e.calloutLength??Lt.calloutLength,r=Lt.discRadius*(e.discScale??1),a=r*i,l=(_,v)=>{const y=[0,1,2,2,3,0];return new Yr(v,[[He.POSITION,new xi([s-_,-_,0,s+_,-_,0,s+_,_,0,s-_,_,0],y,3,!0)],[He.UV0,new xi([0,0,1,0,1,1,0,1],y,2,!0)]])},o=e.calloutWidth??Lt.calloutWidth,c=new ge({width:o,color:e.calloutColor,renderOccluded:x.OccludeAndTransparent,isDecoration:!0}),u=Ve(c,[[0,0,0],[s-r,0,0]]),d=Ve(c,[[0,0,0],[s-a,0,0]]),h=e.customStateMask??rs.None;n.collisionType={type:"disc",direction:[0,0,1],offset:[s,0,0]},n.focusMultiplier=i,n.metadata=e.metadata,n.radius=r,n.renderObjects=[new _e(l(r,t),Ce.Unfocused|h),new _e(u,Ce.Unfocused|h),new _e(l(a,t),Ce.Focused|h),new _e(d,Ce.Focused|h)]}const Te=rs.Custom1,vt=g(),Pn=g(),tn=In(),Ys=new Ye;function yl(n){let e,t,i=[],s=!1;function r(...a){return s&&e===this&&vl(a,i)||(t=n.apply(this,a),e=this,i=a,s=!0),t}return r}function vl(n,e){if(n.length!==e.length)return!1;for(let t=0;t<n.length;++t)if(n[t]!==e[t])return!1;return!0}var te;function Sl(n,e){return{enabled:e.effectiveFeatureEnabled,elevationAlignedStartPoint:n.elevationAlignedStartPoint,elevationAlignedEndPoint:n.elevationAlignedEndPoint,geometry:n.geometry}}function wl(n,e){if(Is(n))return te.Direct;if(!n.enabled)return null;const{geometry:t}=n;if(t==null||P(t.directSegment.startRenderSpace,t.directSegment.endRenderSpace))return null;const{camera:i}=e.state,s=un(b.get(),t,e.renderCoordsHelper),r=Qn(b.get(),t),a=Mt(b.get(),s,R(r,s)),l=ke(b.get(),r,a),o=Bt(l),c=Bt(a),{startRenderSpace:u,endRenderSpace:d}=t.directSegment,h=Math.max(i.computeScreenPixelSizeAt(u)*zi,i.computeScreenPixelSizeAt(d)*zi)**2;return o<h?te.Vertical:c<h?te.Horizontal:null}function Pl(n,e,{constraint:t,view:i}){const{unconstrainedGeometry:s}=n;if(s==null)return;const{renderCoordsHelper:r,spatialReference:a}=i,{startRenderSpace:l,endRenderSpace:o}=s.directSegment,c=r.fromRenderCoords(l,new it,a),u=r.fromRenderCoords(o,new it,a);let d;d=e==="start"?{startPoint:c}:{endPoint:u},Xs(n,d,{constraint:t,elevationAlignedStartPoint:n.elevationAlignedStartPoint,elevationAlignedEndPoint:n.elevationAlignedEndPoint,unconstrainedGeometry:s,view:i})}function Xs(n,e,t){const{constraint:i,elevationAlignedStartPoint:s,elevationAlignedEndPoint:r,unconstrainedGeometry:a,view:l}=t,{dimension:o,previousConstraint:c,preConstraintProperties:u}=n;if(s==null||r==null)return;const d=()=>{"startPoint"in e?o.startPoint=e.startPoint:"endPoint"in e&&(o.endPoint=e.endPoint)};if(i==null)d(),c!=null&&u!=null&&(o.measureType=u.measureType,o.orientation=u.orientation);else switch(o.measureType=E.Direct,i){case te.Horizontal:if(i!==c&&(o.orientation=0),"startPoint"in e){const h=e.startPoint;h!=null&&(h.z=r.z),o.startPoint=h}else if("endPoint"in e){const h=e.endPoint;h!=null&&(h.z=s.z),o.endPoint=h}break;case te.Vertical:if(i!==c&&(o.orientation=Us(a,l)),"startPoint"in e){const h=e.startPoint;h!=null&&(h.x=r.x,h.y=r.y),o.startPoint=h}else if("endPoint"in e){const h=e.endPoint;h!=null&&(h.x=s.x,h.y=s.y),o.endPoint=h}break;case te.Direct:i!==c&&u!=null&&(o.orientation=u.orientation),d()}n.previousConstraint=i,n.unconstrainedGeometry=a}(function(n){n[n.Horizontal=0]="Horizontal",n[n.Vertical=1]="Vertical",n[n.Direct=2]="Direct"})(te||(te={}));let xl=class extends Ls{constructor(e){super(e),this._ray=cs(),this._isWorldDown=!1,this._start=g(),this._end=q(1,0,0),this._width=1,this._color=Qt(1,0,1,1),this._polygonOffset=!1,this._writeDepthEnabled=!0,this._innerWidth=0,this._innerColor=Qt(1,1,1,1),this._stipplePattern=null,this._stippleOffColor=null,this._stipplePreferContinuous=!0,this._falloff=0,this._extensionType=se.LINE,this._laserlineStyle=null,this._laserlineEnabled=!1,this._renderOccluded=x.OccludeAndTransparent,this._fadedExtensions=Ni,this._laserline=new mo({view:this.view,isDecoration:e.isDecoration}),this.applyProperties(e)}destroy(){this._laserline.destroy(),super.destroy()}createObject3DResourceFactory(e){return{view:e,createResources:t=>this._createObject3DResources(t),destroyResources:t=>this._destroyExternalResources(t),recreateGeometry:(t,i)=>this._recreateObject3DGeometry(t,i),cameraChanged:()=>this._updateGeometry()}}createDrapedResourceFactory(e){return{view:e,createResources:()=>this._createDrapedResources(),destroyResources:t=>this._destroyExternalResources(t),recreateGeometry:t=>this._recreateDrapedGeometry(t)}}updateVisibility(e){super.updateVisibility(e),this._laserline.visible=e}onAttachedChange(){this._laserline.attached=this._laserlineAttached}setStartEndFromWorldDownAtLocation(e){this._isWorldDown=!0,L(this._start,e),this.view.renderCoordsHelper.worldUpAtPosition(e,this._end),ke(this._end,e,this._end),fn(this._start,this._end,this._ray),this._updateGeometry()}get start(){return this._start}set start(e){this._isWorldDown=!1,P(this._start,e)||(L(this._start,e),fn(this._start,this._end,this._ray),this._updateGeometry())}get end(){return this._end}set end(e){this._isWorldDown=!1,P(this._end,e)||(L(this._end,e),fn(this._start,this._end,this._ray),this._updateGeometry())}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get color(){return this._color}set color(e){st(e,this._color)||(St(this._color,e),this._updateMaterial())}get polygonOffset(){return this._polygonOffset}set polygonOffset(e){e!==this._polygonOffset&&(this._polygonOffset=e,this._updateMaterial())}get writeDepthEnabled(){return this._writeDepthEnabled}set writeDepthEnabled(e){this._writeDepthEnabled!==e&&(this._writeDepthEnabled=e,this._updateMaterial())}get innerWidth(){return this._innerWidth}set innerWidth(e){e!==this._innerWidth&&(this._innerWidth=e,this._updateMaterial())}get innerColor(){return this._innerColor}set innerColor(e){st(e,this._innerColor)||(St(this._innerColor,e),this._updateMaterial())}get stipplePattern(){return this._stipplePattern}set stipplePattern(e){const t=e!=null!=(this._stipplePattern!=null);this._stipplePattern=e,t?this.recreate():this._updateMaterial()}get stippleOffColor(){return this._stippleOffColor}set stippleOffColor(e){e!=null&&this._stippleOffColor!=null&&st(e,this._stippleOffColor)||(this._stippleOffColor=e!=null?Rs(e):null,this._updateMaterial())}get stipplePreferContinuous(){return this._stipplePreferContinuous}set stipplePreferContinuous(e){e!==this._stipplePreferContinuous&&(this._stipplePreferContinuous=e,this._updateMaterial())}get falloff(){return this._falloff}set falloff(e){e!==this._falloff&&(this._falloff=e,this._updateMaterial())}get extensionType(){return this._extensionType}set extensionType(e){e!==this._extensionType&&(this._extensionType=e,this.recreateGeometry())}get _laserlineAttached(){return this._laserlineEnabled&&this._laserlineStyle!=null&&this.attached&&!this.isDraped}get laserlineStyle(){return this._laserlineStyle}set laserlineStyle(e){this._laserlineStyle=e,this._laserline.attached=this._laserlineAttached,e!=null&&(this._laserline.style=e)}get laserlineEnabled(){return this._laserlineEnabled}set laserlineEnabled(e){this._laserlineEnabled!==e&&(this._laserlineEnabled=e,this._laserline.attached=this._laserlineAttached)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}get _normalizedRenderOccluded(){return this.isDraped&&this._renderOccluded===x.OccludeAndTransparentStencil?x.OccludeAndTransparent:this._renderOccluded}get fadedExtensions(){return this._fadedExtensions}set fadedExtensions(e){this._fadedExtensions=e??Ni,this.recreateGeometry()}_updateMaterial(){var t,i;const{materialParameters:e}=this;(t=this.object3dResources.resources)==null||t.material.setParameters(e),(i=this.drapedResources.resources)==null||i.material.setParameters(e)}get materialParameters(){return{width:this._width,color:this._color,stippleOffColor:this._stippleOffColor,stipplePattern:this._stipplePattern,stipplePreferContinuous:this._stipplePreferContinuous,innerWidth:this._innerWidth,innerColor:this._innerColor,falloff:this._falloff,hasPolygonOffset:this._polygonOffset,renderOccluded:this._normalizedRenderOccluded,isDecoration:this.isDecoration,writeDepth:this._writeDepthEnabled}}_createObject3DResources(e){const t=new ge(this.materialParameters),i=new Array;return this._createObject3DGeometry(t,e,i),{material:t,geometries:i,forEach:s=>{s(t),i.forEach(s)}}}_destroyExternalResources(e){e.geometries=[]}_recreateObject3DGeometry(e,t){e.geometries.length=0,this._createObject3DGeometry(e.material,t,e.geometries)}_createObject3DGeometry(e,t,i){const s=this._createGeometry(e);i.push(s),t.addGeometry(s),this._updateVerticesObject3D(t)}_createDrapedResources(){const e=new ge(this.materialParameters);return{material:e,geometries:[this._createDrapedGeometry(e)]}}_recreateDrapedGeometry(e){e.geometries=[this._createDrapedGeometry(e.material)]}_createDrapedGeometry(e){const t=this._createGeometry(e);return this._updateVerticesDraped(t),new us(t)}_createGeometry(e){const t=this.extensionType===se.FADED,i=t?[g(),g(),g(),g()]:[g(),g()];return Ve(e,i,null,t?[1,1,1,0,1,1,1,1,1,1,1,1,1,1,1,0]:null)}_updateGeometry(){if(this.isDraped)this.drapedResources.recreateGeometry();else{const e=this.object3dResources.object;e&&this._updateVerticesObject3D(e)}}_updateVerticesObject3D(e){const t=this._lineSegment;this._updateVertexAttributesObject3D(e,t),this._laserline.intersectsLine=t}_updateVerticesDraped(e){this._updateVertexAttributesDraped(e,this._lineSegment)}get _lineSegment(){return this._extensionType===se.FADED?this._updateLineSegmentFinite(ki):this._updateLineSegmentInfinite(this._extensionType,ki)}_updateLineSegmentFinite(e){return bi(this._start,this._end,e)}_updateLineSegmentInfinite(e,t){const i=this.view.state.camera;switch(Jr(this._ray,De),e){case se.LINE:De.c0=-Number.MAX_VALUE;break;case se.RAY:case se.GROUND_RAY:{const a=this._ray.origin,l=this.view.elevationProvider.getElevation(a[0],a[1],a[2],this.view.renderCoordsHelper.spatialReference,"ground")??0,o=this.view.renderCoordsHelper.getAltitude(a);this._isWorldDown&&o<l&&ea(De.ray.direction,De.ray.direction),this._extensionType===se.GROUND_RAY&&l!=null&&(De.c1=Math.abs(o-l));break}}if(!ta(i.frustum,De))return this._updateLineSegmentFinite(t);const s=na(De,Fe),r=ia(De,bl);return bi(s,r,t)}_updateVertexAttributesObject3D(e,t){var r;const i=(r=e.geometries[0].getMutableAttribute(He.POSITION))==null?void 0:r.data;if(!i)return;let s=0;for(const a of this._lineVertices(t))i[s++]=a[0],i[s++]=a[1],i[s++]=a[2];e.geometryVertexAttributeUpdated(e.geometries[0],He.POSITION)}_updateVertexAttributesDraped(e,t){var r;const i=(r=e.getMutableAttribute(He.POSITION))==null?void 0:r.data;if(!i)return;let s=0;for(const a of this._lineVertices(t))i[s++]=a[0],i[s++]=a[1],i[s++]=Cn;e.invalidateBoundingInfo()}*_lineVertices(e){this.extensionType===se.FADED?(yield Ke(e,-this.fadedExtensions.start,Fe),yield Ke(e,0,Fe),yield Ke(e,1,Fe),yield Ke(e,1+this.fadedExtensions.end,Fe)):(yield Ke(e,0,Fe),yield Ke(e,1,Fe))}};const De=Qr(),Fe=g(),bl=g(),ki=Kr();var se;(function(n){n[n.LINE=0]="LINE",n[n.RAY=1]="RAY",n[n.GROUND_RAY=2]="GROUND_RAY",n[n.FADED=3]="FADED"})(se||(se={}));const Fi=1/3,Ni={start:Fi,end:Fi};let $l=class extends Ls{constructor(e){super(e),this._location=g(),this._direction=q(1,0,0),this._width=1,this._offset=1,this._length=18,this._color=Qt(1,0,1,1),this._renderOccluded=x.OccludeAndTransparent,this.applyProperties(e)}createObject3DResourceFactory(e){return{view:e,createResources:t=>this._createObject3DResources(t),destroyResources:t=>this._destroyObject3DResources(t),recreateGeometry:(t,i)=>this._recreateObject3DGeometry(t,i),cameraChanged:()=>this._updateGeometry()}}createDrapedResourceFactory(e){return{view:e,createResources:()=>this._createDrapedResources(),destroyResources:t=>this._destroyDrapedResources(t),recreateGeometry:t=>this._recreateDrapedGeometry(t)}}get location(){return this._location}set location(e){P(this._location,e)||(L(this._location,e),this._updateGeometry())}get direction(){return this._direction}set direction(e){P(this._direction,e)||(L(this._direction,e),this._updateGeometry())}setDirectionFromPoints(e,t){is(this._direction,ke(this._direction,t,e)),this._updateGeometry()}get width(){return this._width}set width(e){e!==this._width&&(this._width=e,this._updateMaterial())}get offset(){return this._offset}set offset(e){e!==this._offset&&(this._offset=e,this._updateGeometry())}get length(){return this._length}set length(e){e!==this._length&&(this._length=e,this._updateGeometry())}get color(){return this._color}set color(e){st(e,this._color)||(St(this._color,e),this._updateMaterial())}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial())}_createObject3DResources(e){const t=new ge(this.materialParameters),i=new Array;return this._createObject3DGeometry(t,e,i),{material:t,geometries:i,forEach:s=>{s(t),i.forEach(s)}}}_destroyObject3DResources(e){e.geometries.length=0}_recreateObject3DGeometry(e,t){e.geometries.length=0,this._createObject3DGeometry(e.material,t,e.geometries)}_createObject3DGeometry(e,t,i){const[s,r]=this._createGeometries(e);t.addGeometry(s),t.addGeometry(r),i.push(s),i.push(r),this._updateVerticesObject3D(t)}_createDrapedResources(){const e=new ge(this.materialParameters),t=S(()=>this.view.state.contentPixelRatio,()=>{this.drapedResources.recreateGeometry()});return{material:e,geometries:this._createDrapedGeometry(e),pixelRatioHandle:t}}_destroyDrapedResources(e){e.pixelRatioHandle.remove(),e.geometries=[]}_recreateDrapedGeometry(e){e.geometries=this._createDrapedGeometry(e.material)}_createDrapedGeometry(e){const t=this._createGeometries(e);return this._updateVerticesDraped(t),t.map(i=>new us(i))}_createGeometries(e){return[Ve(e,[g(),g()]),Ve(e,[g(),g()])]}_updateMaterial(){var t,i;const{materialParameters:e}=this;(t=this.object3dResources.resources)==null||t.material.setParameters(e),(i=this.drapedResources.resources)==null||i.material.setParameters(e)}get materialParameters(){return{width:this._width,color:this._color,renderOccluded:this._renderOccluded,isDecoration:this.isDecoration}}_updateGeometry(){if(this.isDraped)this.drapedResources.recreateGeometry();else{const e=this.object3dResources.object;e&&this._updateVerticesObject3D(e)}}_updateVerticesObject3D(e){const t=this.view.state.camera;t.projectToScreen(this.location,kt),Fn(ce,this.location,this.direction),t.projectToScreen(ce,Je),sa(Je,ve(Je,Je,kt)),this._updateVertexAttributesObject3D(t,e,0,kt,Je,1),this._updateVertexAttributesObject3D(t,e,1,kt,Je,-1)}_updateVertexAttributesObject3D(e,t,i,s,r,a){var d;const l=t.geometries[i],o=(d=l.getMutableAttribute(He.POSITION))==null?void 0:d.data;if(!o)return;const{start:c,end:u}=this._computeStartEnd(r,s,a,this.offset,this.width,this.length);e.unprojectFromScreen($i(c),ce),o[0]=ce[0],o[1]=ce[1],o[2]=ce[2],e.unprojectFromScreen($i(u),ce),o[3]=ce[0],o[4]=ce[1],o[5]=ce[2],t.geometryVertexAttributeUpdated(l,He.POSITION)}_updateVerticesDraped(e){const{view:{basemapTerrain:{overlayManager:t},state:{contentPixelRatio:i}}}=this,{location:s,width:r,length:a,offset:l}=this,o=Ml;o.spatialReference=t.renderer.spatialReference,o.x=s[0],o.y=s[1];const c=this.view.overlayPixelSizeInMapUnits(o)*i,u=r*c,d=a*c,h=l*c;this._updateVertexAttributesDraped(e[0],u,d,h,-1),this._updateVertexAttributesDraped(e[1],u,d,h,1)}_updateVertexAttributesDraped(e,t,i,s,r){var d;const a=(d=e.getMutableAttribute(He.POSITION))==null?void 0:d.data;if(!a)return;const{location:l,direction:o}=this,{start:c,end:u}=this._computeStartEnd(o,l,r,s,t,i);a[0]=c[0],a[1]=c[1],a[2]=Cn,a[3]=u[0],a[4]=u[1],a[5]=Cn,e.invalidateBoundingInfo()}_computeStartEnd(e,t,i,s,r,a){const l=mn(ji,ds(ji,e[1]*i,e[0]*-i),s+r/2),o=Dt(Gt,Dt(Gt,Dt(Gt,t,mn(Gt,e,a/2)),l),l);return{start:o,end:Dt(qi,o,mn(qi,e,-a))}}};const ce=g(),ji=B(),Gt=B(),qi=B(),kt=ps(),Je=ps(),Ml=Ae(0,0,void 0,null);function El(n,e,t){return q(n,e,t)}function gu(n){return n}function Ge(n,e,t){return q(n,e,t)}function lt(n){return Se(n)}function M(n,e,{coordinateHelper:t,elevationInfo:i}){return n?mt(t.vectorToDehydratedPoint(n,Ol),e,i):null}function mt(n,e,t){if(n==null)return null;if(e==null)return q(n.x,n.y,n.z??0);if(e.type==="2d")return q(n.x,n.y,0);const i=po(e,n,t,C)??0;return q(n.x,n.y,i)}function Ui(n,e){return Ae(n[0],n[1],n[2],e)}const Ol=Ae(0,0,0,null);let ae=class extends hs{constructor(){super(...arguments),this.enabled=!0}};p([f({type:Boolean})],ae.prototype,"enabled",void 0),ae=p([z("esri.views.interactive.snapping.Settings.DefaultSnappingAlgorithm")],ae);let $=class extends hs{constructor(e){super(e),this.lineSnapper=new ae,this.parallelLineSnapper=new ae,this.rightAngleSnapper=new ae,this.rightAngleTriangleSnapper=new ae,this.shortLineThreshold=15,this.distance=5,this.pointThreshold=1e-6,this.intersectionParallelLineThreshold=1e-6,this.parallelLineThreshold=1e-6,this.verticalLineThreshold=.1,this.touchSensitivityMultiplier=1.5,this.pointOnLineThreshold=1e-6,this.orange=new X([255,127,0]),this.orangeTransparent=new X([255,127,0,.5]),this.lineHintWidthReference=3,this.lineHintWidthTarget=3,this.lineHintFadedExtensions=.3,this.parallelLineHintWidth=2,this.parallelLineHintLength=24,this.parallelLineHintOffset=1.5,this.rightAngleHintSize=24,this.rightAngleHintOutlineSize=1.5,this.satisfiesConstraintScreenThreshold=1}};p([f({type:ae,constructOnly:!0,nonNullable:!0,json:{write:!0}})],$.prototype,"lineSnapper",void 0),p([f({type:ae,constructOnly:!0,nonNullable:!0,json:{write:!0}})],$.prototype,"parallelLineSnapper",void 0),p([f({type:ae,constructOnly:!0,nonNullable:!0,json:{write:!0}})],$.prototype,"rightAngleSnapper",void 0),p([f({type:ae,constructOnly:!0,nonNullable:!0,json:{write:!0}})],$.prototype,"rightAngleTriangleSnapper",void 0),p([f({type:Number,nonNullable:!0,range:{min:-1,max:50,step:1},json:{write:!0}})],$.prototype,"shortLineThreshold",void 0),p([f({type:Number,nonNullable:!0,range:{min:-1,max:50,step:1},json:{write:!0}})],$.prototype,"distance",void 0),p([f({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],$.prototype,"pointThreshold",void 0),p([f({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],$.prototype,"intersectionParallelLineThreshold",void 0),p([f({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],$.prototype,"parallelLineThreshold",void 0),p([f({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],$.prototype,"verticalLineThreshold",void 0),p([f({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],$.prototype,"touchSensitivityMultiplier",void 0),p([f({type:Number,nonNullable:!0,range:{min:0,max:1e-5},json:{write:!0}})],$.prototype,"pointOnLineThreshold",void 0),p([f({type:X,nonNullable:!0})],$.prototype,"orange",void 0),p([f({type:X,nonNullable:!0})],$.prototype,"orangeTransparent",void 0),p([f({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],$.prototype,"lineHintWidthReference",void 0),p([f({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],$.prototype,"lineHintWidthTarget",void 0),p([f({type:Number,nonNullable:!0,range:{min:0,max:1},json:{write:!0}})],$.prototype,"lineHintFadedExtensions",void 0),p([f({type:Number,nonNullable:!0,range:{min:0,max:10},json:{write:!0}})],$.prototype,"parallelLineHintWidth",void 0),p([f({type:Number,nonNullable:!0,range:{min:0,max:50},json:{write:!0}})],$.prototype,"parallelLineHintLength",void 0),p([f({type:Number,nonNullable:!0,range:{min:0,max:5},json:{write:!0}})],$.prototype,"parallelLineHintOffset",void 0),p([f({type:Number,nonNullable:!0,range:{min:0,max:46},json:{write:!0}})],$.prototype,"rightAngleHintSize",void 0),p([f({type:Number,nonNullable:!0,range:{min:0,max:6},json:{write:!0}})],$.prototype,"rightAngleHintOutlineSize",void 0),p([f({type:Number,nonNullable:!0,range:{min:0,max:5},json:{write:!0}})],$.prototype,"satisfiesConstraintScreenThreshold",void 0),$=p([z("esri.views.interactive.snapping.Settings.Defaults")],$);const T=new $;var A;(function(n){n[n.FEATURE=1]="FEATURE",n[n.SELF=2]="SELF",n[n.ALL=3]="ALL"})(A||(A={}));const Wi={redo:"r",undo:"z",center:"Alt",constraint:"Shift",cancel:"Escape",delete:["Backspace","Delete"],complete:"Enter",vertexAdd:"f",pan:" "},Zi={toggle:"Control"};function Xe(n,e){const t=n.x-e.x,i=n.y-e.y;return t*t+i*i}function Cl(n,e){return Math.sqrt(Xe(n,e))}function ei(n,e){e.sort((t,i)=>Yt(t.targetPoint,n)-Yt(i.targetPoint,n))}var N;function vu({point:n,distance:e,returnEdge:t,vertexMode:i,coordinateHelper:{spatialReference:s},filter:r},a,l){return l=l!=null?l.clone():new ra({where:"1=1"}),r&&(l.geometry=r.geometry,l.distance=r.distance,l.spatialRelationship=r.spatialRelationship,l.where=Nn(l.where,r.where),l.timeExtent=aa(l.timeExtent,r.timeExtent),l.objectIds=Tl(l.objectIds,r.objectIds)),{point:Ae(n[0],n[1],n[2],s.toJSON()),mode:a,distance:e,returnEdge:t,vertexMode:i,query:l.toJSON()}}function Tl(n,e){return n||e?e?n?Array.from(oa(new Set(n),new Set(e))):e:n:null}function nn(n,e,t){return{left:M(n.leftVertex.pos,e,t),right:M(n.rightVertex.pos,e,t)}}function Su(n){return n.createQuery()}function Dl(n,e=()=>{}){const t=S(()=>({view:n.view,snappingOptions:n.snappingOptions}),({view:i,snappingOptions:s})=>{const r="snapping-toggle",a=la.TOOL;if(n.removeHandles(r),i&&s!=null){const l=[i.on("key-down",o=>{o.key!==Zi.toggle||o.repeat||(s.enabledToggled=!0,e())},a),i.on("key-up",o=>{o.key===Zi.toggle&&(s.enabledToggled=!1,e())},a),i.on("pointer-move",o=>{const c=o.native.ctrlKey;s.enabledToggled!==c&&(s.enabledToggled=c,e())},a)];n.addHandles(l,r)}},F);n.addHandles(t)}function Rl(n){var e;return n!=null&&typeof n=="object"&&"declaredClass"in n&&n.declaredClass==="esri.WebMap"&&"utilityNetworks"in n&&!!((e=n==null?void 0:n.utilityNetworks)!=null&&e.length)}(function(n){n[n.TARGET=0]="TARGET",n[n.REFERENCE=1]="REFERENCE",n[n.REFERENCE_EXTENSION=2]="REFERENCE_EXTENSION"})(N||(N={}));let Tt=class{constructor(e,t){this.isDraped=e,this.domain=t}},Qs=class Ks extends Tt{constructor(e,t,i=A.ALL){super(t,i),this.intersectionPoint=e}equals(e){return e instanceof Ks&&P(this.intersectionPoint,e.intersectionPoint)}},Q=class Js extends Tt{constructor(e,t,i,s,r=A.ALL,a=!0,l=!0){super(s,r),this.type=e,this.lineStart=t,this.lineEnd=i,this.fadeLeft=a,this.fadeRight=l}equals(e){return e instanceof Js&&this.type===e.type&&P(this.lineStart,e.lineStart)&&P(this.lineEnd,e.lineEnd)&&this.fadeLeft===e.fadeLeft&&this.fadeRight===e.fadeRight}get length(){return _t(this.lineStart,this.lineEnd)}},er=class tr extends Tt{constructor(e,t,i,s=A.ALL){super(i,s),this.lineStart=e,this.lineEnd=t}equals(e){return e instanceof tr&&P(this.lineStart,e.lineStart)&&P(this.lineEnd,e.lineEnd)}},Ll=class nr extends Tt{constructor(e,t,i){super(t,i),this.point=e}equals(e){return e instanceof nr&&P(this.point,e.point)}},ti=class ir extends Tt{constructor(e,t,i,s,r=A.ALL){super(s,r),this.previousVertex=e,this.centerVertex=t,this.nextVertex=i}equals(e){return e instanceof ir&&P(this.previousVertex,e.previousVertex)&&P(this.centerVertex,e.centerVertex)&&P(this.nextVertex,e.nextVertex)}},Al=class{draw(e,t){const i=this._getUniqueHints(e),s=this.sortUniqueHints(i),r=[];for(const a of s)a instanceof Qs&&r.push(this.visualizeIntersectionPoint(a,t)),a instanceof Q&&r.push(this.visualizeLine(a,t)),a instanceof er&&r.push(this.visualizeParallelSign(a,t)),a instanceof ti&&r.push(this.visualizeRightAngleQuad(a,t)),a instanceof Ll&&r.push(this.visualizePoint(a,t));return ca(r)}sortUniqueHints(e){return e}_getUniqueHints(e){const t=[];for(const i of e){let s=!0;for(const r of t)if(i.equals(r)){s=!1;break}s&&t.push(i)}return t}},Hl=class extends Al{sortUniqueHints(e){return e.sort((t,i)=>(i instanceof Q?i.length:0)-(t instanceof Q?t.length:0))}visualizeIntersectionPoint(e,t){const{spatialReference:i,view:s}=t,r=ft(t);return re(new Li({view:s,primitive:"circle",geometry:Ui(e.intersectionPoint,i),elevationInfo:e.isDraped?Ds:C,size:20,outlineSize:2,color:r.intersectionPointColor,outlineColor:r.intersectionPointOutlineColor,pixelSnappingEnabled:!1,isDecoration:!0,attached:!0}))}visualizePoint(e,t){const{view:i,spatialReference:s}=t,r=ft(t),a=Re(e.point,e.domain,t);return re(new Li({view:i,primitive:"circle",geometry:Ui(a,s),elevationInfo:Ft(e,t),size:20,outlineSize:2,color:r.pointColor,outlineColor:r.pointOutlineColor,pixelSnappingEnabled:!1,isDecoration:!0,attached:!0}))}visualizeLine(e,t){const{view:i,spatialReference:s}=t,r=ft(t),a=Re(e.lineStart,e.domain,t),l=Re(e.lineEnd,e.domain,t);return re(this._createLineSegmentHint(e.type,a,l,s,Ft(e,t),i,r,e.isDraped,e.fadeLeft,e.fadeRight))}visualizeParallelSign(e,t){const{view:i,spatialReference:s}=t,r=ft(t),{isDraped:a}=e,l=Ft(e,t),o=Re(e.lineStart,e.domain,t),c=Re(e.lineEnd,e.domain,t),u=Ne(o,s,l,i,a),d=Ne(c,s,l,i,a),h=fs(d,u,d,.5),m=new $l({view:i,attached:!1,offset:T.parallelLineHintOffset,length:T.parallelLineHintLength,width:T.parallelLineHintWidth,color:r.parallelSignColor,location:h,renderOccluded:a?x.OccludeAndTransparent:x.Opaque,isDraped:a,renderGroup:gn.SnappingHint,isDecoration:!0});return m.setDirectionFromPoints(u,h),m.attached=!0,re(m)}visualizeRightAngleQuad(e,t){const{view:i,spatialReference:s}=t,r=ft(t),a=Ft(e,t),{isDraped:l}=e,o=Re(e.previousVertex,e.domain,t),c=Re(e.centerVertex,e.domain,t),u=Re(e.nextVertex,e.domain,t),d=Ne(o,s,a,i,l),h=Ne(c,s,a,i,l),m=Ne(u,s,a,i,l);return re(new fo({view:i,attached:!0,color:l?r.rightAngleColorDraped:r.rightAngleColor,renderOccluded:l?x.OccludeAndTransparent:x.Transparent,outlineRenderOccluded:l?x.OccludeAndTransparent:x.Opaque,outlineColor:r.rightAngleOutlineColor,outlineSize:T.rightAngleHintOutlineSize,size:T.rightAngleHintSize,isDraped:l,geometry:{previous:d,center:h,next:m},renderGroup:gn.SnappingHint,isDecoration:!0}))}_createLineSegmentHint(e,t,i,s,r,a,l,o=!1,c=!0,u=!0){const d=Ne(t,s,r,a,o),h=Ne(i,s,r,a,o),m=new xl({view:a,extensionType:se.FADED,start:d,end:h,isDraped:o,color:l.lineColor,renderOccluded:o?x.OccludeAndTransparent:x.Opaque,renderGroup:gn.SnappingHint,isDecoration:!0});switch(e){case N.TARGET:m.width=T.lineHintWidthTarget,m.fadedExtensions={start:0,end:T.lineHintFadedExtensions};break;case N.REFERENCE_EXTENSION:m.width=T.lineHintWidthReference,m.fadedExtensions={start:0,end:0};break;case N.REFERENCE:m.width=T.lineHintWidthReference,m.fadedExtensions={start:c?T.lineHintFadedExtensions:0,end:u?T.lineHintFadedExtensions:0}}return m.attached=!0,m}};function ft(n){const{effectiveTheme:e}=n.view,t=X.toUnitRGBA(e.accentColor),i=[0,0,0,0];return{intersectionPointColor:i,intersectionPointOutlineColor:t,pointColor:i,pointOutlineColor:t,lineColor:t,lineOutlineColor:void 0,parallelSignColor:t,rightAngleColor:t,rightAngleColorDraped:X.toUnitRGBA(ss(e.accentColor,.5)),rightAngleOutlineColor:t}}function Re(n,e,t){const i=sr(e,t);return i==null?n:El(n[0],n[1],i)}function Ft(n,e){return sr(n.domain,e)!=null?e.selfSnappingZ.elevationInfo:n.isDraped?Ds:C}function sr(n,{selfSnappingZ:e}){return n===A.SELF&&e!=null?e.value:null}function Ne(n,e,t,i,s,r=g()){if(s){const a=i.basemapTerrain.overlayManager.renderer.spatialReference;Ut(n,e,r,a)}else Ja(n,e,t,i,r);return r}function zl(n,e,t,i,s){const r=Mi(3*n.length),a=Mi(r.length);n.forEach((c,u)=>{r[3*u]=c[0],r[3*u+1]=c[1],r[3*u+2]=c.length>2?c[2]:0});const l=ua(r,e,0,a,0,r,0,r.length/3,t,i,s),o=l!=null;return{numVertices:n.length,position:r,mapPositions:a,projectionSuccess:o,sampledElevation:l}}let Vl=class extends $s{constructor(e){super(e),this.view=null,this._renderOccluded=x.OccludeAndTransparent,this._vertices=null,this._spatialReference=null,this._color=Ei([1,127/255,0,1]),this._size=11,this._outlineColor=Ei([0,0,0,.5]),this._outlineSize=1,this._elevationInfo=null,this.applyProperties(e)}get renderOccluded(){return this._renderOccluded}set renderOccluded(e){e!==this._renderOccluded&&(this._renderOccluded=e,this._updateMaterial(),this._updateOutlineMaterial())}get vertices(){return this._vertices}set vertices(e){this._vertices=e,this.recreateGeometry()}get spatialReference(){return this._spatialReference}set spatialReference(e){this._spatialReference=e,this.recreateGeometry()}get color(){return this._color}set color(e){st(e,this._color)||(St(this._color,e),this._updateMaterial())}get size(){return this._size}set size(e){e!==this._size&&(this._size=e,this._updateMaterial())}get outlineColor(){return this._outlineColor}set outlineColor(e){st(e,this._outlineColor)||(St(this._outlineColor,e),this._updateOutlineMaterial())}get outlineSize(){return this._outlineSize}set outlineSize(e){e!==this._outlineSize&&(this._outlineSize=e,this._updateOutlineMaterial())}get elevationInfo(){return this._elevationInfo}set elevationInfo(e){this._elevationInfo=e,this.recreateGeometry()}get _vertexMaterialParameters(){return{color:this._color,screenSizeScale:this.size,renderOccluded:this._renderOccluded,isDecoration:this.isDecoration}}get _vertexOutlineMaterialParameters(){return{color:this._outlineColor,screenSizeScale:this.size+2*this.outlineSize,renderOccluded:this._renderOccluded,isDecoration:this.isDecoration}}_updateMaterial(){this.attached&&this._vertexMaterial.setParameters(this._vertexMaterialParameters)}_updateOutlineMaterial(){this.attached&&this._vertexOutlineMaterial.setParameters(this._vertexOutlineMaterialParameters)}_createRenderGeometries(){const e=this.vertices;if(e==null||e.length===0)return[];const t=.5,i=.5,s=zl(e,this.spatialReference,this.view.elevationProvider,this.view.renderCoordsHelper,da.fromElevationInfo(this.elevationInfo)),r=[],a=s.numVertices,l=s.position;for(let o=0;o<a;++o){const c=ne(Il,l[3*o],l[3*o+1],l[3*o+2]),u=Bi(this._vertexMaterial,t,c),d=Bi(this._vertexOutlineMaterial,i,c);r.push({vertexGeometry:u,vertexOutlineGeometry:d})}return r}createGeometries(e){const t=this._createRenderGeometries();for(const{vertexGeometry:i,vertexOutlineGeometry:s}of t)e.addGeometry(i),e.addGeometry(s)}createExternalResources(){this._vertexMaterial=new Ri({...this._vertexMaterialParameters,writeDepth:!0,cullFace:Oi.Back,screenSizeEnabled:!0}),this._vertexOutlineMaterial=new Ri({...this._vertexOutlineMaterialParameters,forceTransparentMode:!0,writeDepth:!0,cullFace:Oi.Front,screenSizeEnabled:!0,shadingEnabled:!1})}destroyExternalResources(){this._vertexMaterial=null,this._vertexOutlineMaterial=null}forEachExternalMaterial(e){e(this._vertexMaterial),e(this._vertexOutlineMaterial)}};const Il=g();function Bi(n,e,t){return as(n,e,16,16,{offset:t})}let We=class extends K{constructor(e){super(e),this.layer=null,this.enabled=!0,this.updating=!1,this.availability=1}};p([f({constructOnly:!0})],We.prototype,"layer",void 0),p([f()],We.prototype,"enabled",void 0),p([f()],We.prototype,"updating",void 0),p([f()],We.prototype,"availability",void 0),We=p([z("esri.views.interactive.snapping.FeatureSnappingLayerSource")],We);const rr=We;let U=class extends K{constructor(e){super(e),this.enabled=!1,this.enabledToggled=!1,this.selfEnabled=!0,this.featureEnabled=!0,this.featureSources=new Et,this.distance=T.distance,this.touchSensitivityMultiplier=T.touchSensitivityMultiplier}get effectiveEnabled(){return this.enabledToggled?!this.enabled:this.enabled}get effectiveSelfEnabled(){return this.effectiveEnabled&&this.selfEnabled}get effectiveFeatureEnabled(){return this.effectiveEnabled&&this.featureEnabled}};p([f()],U.prototype,"enabled",void 0),p([f()],U.prototype,"enabledToggled",void 0),p([f()],U.prototype,"selfEnabled",void 0),p([f()],U.prototype,"featureEnabled",void 0),p([f({type:Et.ofType(rr)})],U.prototype,"featureSources",void 0),p([f()],U.prototype,"distance",void 0),p([f()],U.prototype,"touchSensitivityMultiplier",void 0),p([f({readOnly:!0})],U.prototype,"effectiveEnabled",null),p([f({readOnly:!0})],U.prototype,"effectiveSelfEnabled",null),p([f({readOnly:!0})],U.prototype,"effectiveFeatureEnabled",null),U=p([z("esri.views.interactive.snapping.SnappingOptions")],U);const ar=U;function Gl(n,e){const t=new ar({enabled:!0,selfEnabled:!1,featureEnabled:!0,distance:(e==null?void 0:e.distance)??T.distance,touchSensitivityMultiplier:(e==null?void 0:e.touchSensitivityMultiplier)??T.touchSensitivityMultiplier});return{...S(()=>{var i,s;return((s=(i=n.map)==null?void 0:i.allLayers)==null?void 0:s.toArray())??[]},i=>{t.featureSources=new Et(i.map(s=>new rr({layer:s,enabled:!0})))},ot),options:t}}function ni({start:n,end:e,type:t},i,s){const r=[],a=ve(Qe,e,n),l=ve(ut,n,i),o=wt(a),c=2*Ot(a,l),u=c*c-4*o*(wt(l)-s*s);if(u===0){const d=-c/(2*o);(t===Y.PLANE||d>=0)&&r.push(yt(B(),n,a,d))}else if(u>0){const d=Math.sqrt(u),h=(-c+d)/(2*o);(t===Y.PLANE||h>=0)&&r.push(yt(B(),n,a,h));const m=(-c-d)/(2*o);(t===Y.PLANE||m>=0)&&r.push(yt(B(),n,a,m))}return r}function or(n,e){const t=n.start,i=n.end,s=ve(Qe,i,t),r=ne(ut,-s[1],s[0],0),a=e.start,l=e.end,o=D(ri,l,a),c=R(o,r),u=ne(gr,t[0],t[1],0),d=D(_r,u,a),h=R(d,r);if(Math.abs(c)<ye)return[];const m=k(yr,a,o,h/c);if(e.type===H.RAY){const _=D(rn,m,a);if(R(_,o)<-ye)return[]}if(n.type===Y.HALF_PLANE){const _=ma(rn,m,t);if(Ot(_,s)<-ye)return[]}return[Se(m)]}function kl(n,e){return Fl(sn(ai,e[2],n),e)}function lr(n,e){const i=hr(sn(ai,0,n),sn(Wl,0,e)),s=[];for(const r of i)s.push(ga(r));return s}function cr(n,e){return ii(n,sn(ai,n[2],e))}function ur(n,e,t){const i=ve(Qe,n,e),s=t/_a(i),r=yt(g(),e,i,s);return r[2]=n[2],r}function ii(n,{start:e,end:t,type:i}){const s=D(Qe,n,e),r=D(ut,t,e),a=R(s,r)/R(r,r);return k(g(),e,r,i===H.RAY?Math.max(a,0):a)}const dr=(()=>{const n=g(),e=g(),t=g();return({start:i,end:s},{center:r,radius:a,normal:l,slicePlane:o})=>{const c=g(),u=Be(r,l,Ul);if(O(Tn(u,i),0)&&O(Tn(u,s),0)){pa(l,n,e);const d=(_,v)=>(ke(t,v,r),ds(_,R(t,n),R(t,e)),_),h=go({start:d(mr,i),end:d(ql,s),type:H.LINE},fa,a),m=[];for(const[_,v]of h){const y=L(g(),r);k(y,y,n,_),k(y,y,e,v),o&&!ze(o,y)||m.push(y)}return m}return ms(u,i,s,c)?!O(_t(c,r),a)||o&&!ze(o,c)?[]:[c]:[]}})();function pr({start:n,end:e,type:t},i,s){const r=[],a=ke(Qe,e,n),l=ve(ut,n,i),o=wt(a),c=2*Ot(a,l),u=c*c-4*o*(wt(l)-s*s);if(u===0){const d=-c/(2*o);(t===H.LINE||d>=0)&&r.push(k(g(),n,a,d))}else if(u>0){const d=Math.sqrt(u),h=(-c+d)/(2*o);(t===H.LINE||h>=0)&&r.push(k(g(),n,a,h));const m=(-c-d)/(2*o);(t===H.LINE||m>=0)&&r.push(k(g(),n,a,m))}return r}function hr(n,e){const t=n.start,i=n.end,s=e.start,r=e.end,a=D(Qe,i,t),l=D(ut,r,s),o=D(ri,s,t),c=me(gr,a,l),u=R(o,c);if(!Ci(u,0,ye))return[];const d=Dn(c);if(Ci(d,0,ye))return[];const h=me(_r,o,l),m=R(h,c)/d,_=k(yr,t,a,m);if(n.type===H.RAY){const v=D(rn,_,t);if(R(a,v)<-ye)return[]}if(e.type===H.RAY){const v=D(rn,_,s);if(R(l,v)<-ye)return[]}return[Se(_)]}function Fl({start:n,end:e,type:t},i){const s=D(Qe,i,n),r=D(ut,e,n),a=me(ri,r,s);if(Dn(a)/Dn(r)<ye)switch(t){case H.LINE:return[Se(i)];case H.RAY:return R(r,s)<-ye?[]:[Se(i)]}return[]}function si(n,e,t,i){const[s,r]=n,[a,l]=t,o=a-s,c=l-r,u=o*o+c*c,d=Math.sqrt(u);if(d>e+i)return[];if(d<Math.abs(e-i))return[];if(O(d,0)&&O(e,i))return[];const h=(e*e-i*i+u)/(2*d),m=Math.sqrt(e*e-h*h),_=m*c/d,v=m*o/d,[y,w]=gs(mr,n,t,h/d);return O(_,v)?[_n(y,w)]:[_n(y+_,w-v),_n(y-_,w+v)]}function sn(n,e,{start:t,end:i,type:s}){return ne(n.start,t[0],t[1],e),ne(n.end,i[0],i[1],e),n.type=jl[s],n}function fr(n,e){return O(n[2],e[2])}function O(n,e){return Math.abs(n-e)<ye}function Nl(n,e){return e.filter(t=>ze(n,t))}function ze(n,e){return ha(n,e)}var Y;(function(n){n[n.PLANE=0]="PLANE",n[n.HALF_PLANE=1]="HALF_PLANE"})(Y||(Y={}));const jl={[Y.PLANE]:H.LINE,[Y.HALF_PLANE]:H.RAY},ye=1e-6,mr=B(),ql=B(),Qe=g(),ut=g(),ri=g(),gr=g(),_r=g(),yr=g(),rn=g(),Ul=I(),ai={start:g(),end:g(),type:H.LINE},Wl={start:g(),end:g(),type:H.LINE};class we{intersect(e){return Pe(this,e)}closestPoints(e){return[this.closestTo(e)]}}class dt extends we{constructor(e){super(),this.point=e}equals(e){return this===e||ue(e)&&P(this.point,e.point)}closestTo(){return lt(this.point)}}class oi extends we{constructor(e,t,i){super(),this.start=e,this.end=t,this.lineLike={start:e,end:t,type:i}}equals(e){return this===e||de(e)&&this.lineLike.type===e.lineLike.type&&P(this.start,e.start)&&P(this.end,e.end)}closestTo(e){const t=ii(e,this.lineLike);return t}}class li extends oi{constructor(e,t){super(e,t,H.LINE)}}class Zl extends oi{constructor(e,t){super(e,t,H.RAY)}}class vr extends we{constructor(e){super(),this.constraints=e}equals(e){return this===e||Hn(e)&&Sa(this.constraints,e.constraints,(t,i)=>t.equals(i))}closestTo(e){let t,i=1/0;for(const s of this.constraints){const r=s.closestTo(e),a=Yt(e,r);a<i&&(i=a,t=r)}return t?lt(t):e}closestPoints(e){return this.constraints.flatMap(t=>t===this?[]:t.closestPoints(e))}}class Sr extends we{constructor(e,t){super(),this.center=e,this.radius=t}equals(e){return this===e||he(e)&&this.center[0]===e.center[0]&&this.center[1]===e.center[1]&&this.radius===e.radius}closestTo(e){const t=ur(e,this.center,this.radius);return t}}class ci extends we{constructor(e,t){super(),this.center=e,this.radius=t}equals(e){return this===e||be(e)&&P(this.center,e.center)&&this.radius===e.radius}closestTo(e){const t=ur(e,this.center,this.radius);return t[2]=this.center[2],t}asCircle(){return new ui(lt(this.center),this.radius,Ge(0,0,1))}}let ui=class extends we{constructor(e,t,i,s=void 0){super(),this.center=e,this.radius=t,this.normal=i,this.slicePlane=s}equals(e){return this===e||Le(e)&&P(this.center,e.center)&&P(this.normal,e.normal)&&this.radius===e.radius}closestTo(e){const{center:t,radius:i}=this;_s(this.getPlane(Bl),e,xn);const s=D(xn,xn,t),r=Bt(s);if(O(r,0))return lt(e);const a=i/Math.sqrt(r),l=k(g(),t,s,a),{slicePlane:o}=this;if(o&&!ze(o,l)){const c=pi(o,this);return(c==null?void 0:c.closestTo(e))??lt(e)}return l}getPlane(e=I()){return Be(this.center,this.normal,e)}};const xn=g(),Bl=I();class Yl extends we{constructor(e){super(),this.z=e}equals(e){return this===e||xe(e)&&this.z===e.z}closestTo(e){return q(e[0],e[1],this.z)}getPlane(e=I()){return ne(Yi,0,0,this.z),Be(Yi,Pa,e)}}const Yi=g();class di extends we{constructor(e,t,i){super(),this.start=e,this.end=t,this.planeLike={start:e,end:t,type:i}}equals(e){return this===e||pe(e)&&this.planeLike.type===e.planeLike.type&&P(this.start,e.start)&&P(this.end,e.end)}closestTo(e){return cr(e,this.planeLike)}closestEndTo(e){const{start:t,end:i}=this;return Math.sign(Ot(ve(Xl,i,t),ve(Ql,e,t)))>0?i:t}getPlane(e=I()){const t=L(Xi,this.end);return t[2]+=1,xa(this.start,this.end,t,e)}getSlicePlane(e=I()){const{start:t,end:i,type:s}=this.planeLike;if(s===Y.PLANE)return;const r=ne(Xi,t[0],t[1],0),a=ne(Qi,i[0],i[1],0),l=ke(Qi,a,r);return Be(r,l,e),e}}const Xl=B(),Ql=B(),Xi=g(),Qi=g();class wr extends di{constructor(e,t){super(e,t,Y.HALF_PLANE)}}class Pr extends di{constructor(e,t){super(e,t,Y.PLANE)}}class Kl extends we{constructor(e,t){super(),this.sphere=ba(e,t)}equals(e){return this===e||$e(e)&&$a(this.sphere,e.sphere)}closestTo(e){const t=Ma(this.sphere,e,g());return t}get center(){return this.sphere}get radius(){return this.sphere[3]}}class xr extends we{constructor(e,t,i){super(),this.start=e,this.end=t,this.getZ=i,this.planeLike={start:e,end:t,type:Y.PLANE}}equals(e){return this===e||an(e)&&P(this.start,e.start)&&P(this.end,e.end)&&this.getZ===e.getZ}closestTo(e){return Jl(this,e)}addIfOnTheGround(e,t){for(const i of t){const s=this.getZ(i[0],i[1])??0;O(i[2],s)&&(i[2]=s,e.push(i))}}}function Jl(n,e){const t=cr(e,n.planeLike);return t[2]=n.getZ(t[0],t[1])??$r,t}function Pe(n,e){if(Hn(n)){const t=[];for(const i of n.constraints){const s=i.intersect(e);s&&t.push(s)}return hi(t)}if(Hn(e))return Pe(e,n);if(an(n))return Ki(n,e);if(an(e))return Ki(e,n);if(ue(n)){const{point:t}=n,i=e.closestTo(t);return Vn(i,t)?n:void 0}if(de(n)){if(ue(e))return Pe(e,n);if(de(e))return oe(hr(n.lineLike,e.lineLike));if(xe(e))return ec(n,e);if(pe(e))return oe(or(e.planeLike,n.lineLike));if(he(e))return oe(pr(n.lineLike,e.center,e.radius));if(Le(e))return oe(dr(n.lineLike,e));if(be(e))return tc(n,e);if($e(e))return nc(n,e)}else if(xe(n)){if(ue(e)||de(e))return Pe(e,n);if(xe(e))return ic(n,e);if(pe(e))return sc(n,e);if(he(e))return rc(n,e);if(Le(e))return oc(n,e);if(be(e))return ac(n,e);if($e(e))return lc(n,e)}else if(pe(n)){if(ue(e)||de(e)||xe(e))return Pe(e,n);if(pe(e))return bn(lr(n.planeLike,e.planeLike));if(he(e))return bn(ni(n.planeLike,e.center,e.radius));if(Le(e))return uc(n,e);if(be(e))return cc(n,e);if($e(e))return dc(n,e)}else if(he(n)){if(ue(e)||de(e)||xe(e)||pe(e))return Pe(e,n);if(he(e))return bn(si(n.center,n.radius,e.center,e.radius));if(Le(e))return void 0;if(be(e))return pc(n,e);if($e(e))return void 0}else if(Le(n)){if(ue(e)||de(e)||xe(e)||pe(e)||he(e))return Pe(e,n);if(Le(e))return void 0;if(be(e))return e.asCircle(),void 0;if($e(e))return void 0}else if(be(n)){if(ue(e)||de(e)||xe(e)||pe(e)||he(e)||Le(e))return Pe(e,n);if(be(e))return hc(e,n);if($e(e))return void 0}else if($e(n)){if(ue(e)||de(e)||xe(e)||pe(e)||he(e)||be(e))return Pe(e,n);if($e(e))return void 0}}const ec=(()=>{const n=I();return(e,t)=>{const{start:i,end:s}=e;if(fr(i,s)&&O(i[2],t.z))return e;const r=g();return ms(t.getPlane(n),i,s,r)?new dt(r):void 0}})();function tc({lineLike:n},{center:e,radius:t}){const i=e[2];return oe(pr(n,e,t).filter(s=>O(s[2],i)))}function nc({lineLike:n},{sphere:e}){return oe(wa(e,n.start,n.end))}const pi=(()=>{const n=cs(),e=I(),t={start:g(),end:g(),type:H.LINE};return(i,s,r)=>{const{normal:a,center:l,radius:o}=s,c=R(a,kn(i)),u=O(Tn(i,l),0);if(O(c,1))return u?s:void 0;if(s.getPlane(e),u&&O(c,0)&&Ti(i)&&Ti(e)){if(O(o,0))return!r||ze(r,l)?new dt(lt(l)):void 0;const h=Se(l);h[2]+=o;const m=Se(l);m[2]-=o;const _=[];return r&&!ze(r,h)||_.push(h),r&&!ze(r,m)||_.push(m),oe(_)}if(!ya(i,e,n))return;L(t.start,n.origin),Fn(t.end,n.origin,n.direction);const d=dr(t,s);return oe(r?Nl(r,d):d)}})();function ic(n,e){return O(n.z,e.z)?n:void 0}function sc({z:n},{planeLike:e}){const[t,i]=e.start,[s,r]=e.end,a=Ge(t,i,n),l=Ge(s,r,n);return e.type===Y.PLANE?new li(a,l):new Zl(a,l)}function rc(n,e){const[t,i]=e.center;return new ci(Ge(t,i,n.z),e.radius)}function ac(n,e){return O(e.center[2],n.z)?e:void 0}const oc=(()=>{const n=I();return(e,t)=>pi(e.getPlane(n),t)})();function lc(n,{center:e,radius:t}){const i=Math.abs(e[2]-n.z);if(i>t&&!O(i,t))return;const s=Ge(e[0],e[1],n.z),r=Math.sqrt(t**2-i**2);return O(r,0)?void 0:new ci(s,r)}const cc=(()=>{const n=I();return(e,{center:t,radius:i})=>{const s=ni(e.planeLike,t,i),r=t[2];e.getSlicePlane(n);const a=[];for(const[l,o]of s){const c=[l,o,r];ze(n,c)&&a.push(c)}return oe(a)}})(),uc=(()=>{const n=I(),e=I();return(t,i)=>pi(t.getPlane(n),i,t.getSlicePlane(e))})(),dc=(()=>{const n=I();return(e,{center:t,radius:i})=>{const s=e.getPlane(n),r=On(s,t),a=Math.abs(r);if(a>i&&!O(a,i))return;const l=Se(kn(s)),o=k(g(),t,l,r),c=Math.sqrt(i**2-r**2);return O(c,0)?new dt(_s(s,t,g())):new ui(o,c,l,e.getSlicePlane())}})();function pc(n,e){const t=Ie(n.center,e.center);return O(t,0)&&O(n.radius,e.radius)?e:br(si(n.center,n.radius,e.center,e.radius),e.center[2])}function hc(n,e){if(!fr(n.center,e.center))return;const t=Ie(n.center,e.center);return O(t,0)&&O(n.radius,e.radius)?n:br(si(n.center,n.radius,e.center,e.radius),n.center[2])}function Ki(n,e){const{planeLike:t,getZ:i}=n,s=[];if(ue(e))n.addIfOnTheGround(s,kl(t,e.point));else if(de(e))n.addIfOnTheGround(s,or(t,e.lineLike));else if(he(e))for(const[r,a]of ni(t,e.center,e.radius)){const l=i(r,a);l!=null&&s.push(q(r,a,l))}else if(pe(e)||an(e))for(const[r,a]of lr(t,e.planeLike)){const l=i(r,a)??$r;s.push(q(r,a,l))}return oe(s)}function bn(n){return hi(n.map(([e,t])=>{const i=Ge(e,t,0),s=Ge(e,t,1);return new li(i,s)}))}function oe(n){return hi(n.map(e=>e?new dt(e):void 0))}function br(n,e){return oe(n.map(([t,i])=>[t,i,e]))}function hi(n){if(n.length!==0)return n.length===1?n[0]??void 0:new vr(n.filter(va))}function Hn(n){return n instanceof vr}function ue(n){return n instanceof dt}function de(n){return n instanceof oi}function xe(n){return n instanceof Yl}function pe(n){return n instanceof di}function he(n){return n instanceof Sr}function be(n){return n instanceof ci}function Le(n){return n instanceof ui}function $e(n){return n instanceof Kl}function an(n){return n instanceof xr}const $r=0;let ee=class extends K{get layerView(){var e,t;return(t=(e=this.view)==null?void 0:e.allLayerViews)==null?void 0:t.find(i=>i.layer===this.layer)}get valid(){return this._valid}get subtypeFilter(){var s,r;const{layer:e}=this;if(!Ea(e)||!((s=e.subtypes)!=null&&s.length))return{mode:"not-in-use",filter:null};const t=((r=e.fieldsIndex.get(e.subtypeField))==null?void 0:r.name)??e.subtypeField,i=e.sublayers.filter(a=>a.visible).map(a=>a.subtypeCode);return i.length?i.length===e.subtypes.length?{mode:"all-visible",filter:null}:i.length===1?{mode:"in-use",filter:`${t} = ${i.getItemAt(0)}`}:{mode:"in-use",filter:`${t} IN (${i.join(", ")})`}:{mode:"none-visible",filter:null}}get floorFilter(){const{view:e,layer:t}=this;return e&&t?wo({view:e,layer:t}):null}constructor(e){super(e),this.rulesTable=null,this._valid=!1}initialize(){if(!this.snappingSource||!this.layer)return;const{layer:e,snappingSource:t}=this;if("refresh"in e){const i=e;this.addHandles(i.on("refresh",()=>t.refresh()))}this.loadRules(),this.addHandles([S(()=>t.updating,i=>t.layerSource.updating=i,F),S(()=>t.availability,i=>t.layerSource.availability=i,F)])}getFetchCandidatesParameters(e,t,i){var u,d;if(!this.valid)return[];const{layer:s,layerView:r,floorFilter:a,rulesTable:l,subtypeFilter:o}=this,c={distance:i,mode:((u=this.view)==null?void 0:u.type)??"2d",point:e,coordinateHelper:t.coordinateHelper,...this._types,filter:r&&"filter"in r?r.filter:null};if(a&&(c.filter=$n(c.filter,a)),o.mode!=="not-in-use"&&o.mode!=="all-visible"){if(o.mode==="none-visible")return[];c.filter?c.filter.where=Nn(c.filter.where,o.mode):c.filter=new Wt({where:o.filter})}if(l){const h=t.feature,m=h==null?void 0:h.sourceLayer;if(!(h&&yn(s)&&s.layerId&&yn(m)&&l.loadStatus==="loaded"))return[];const _=[],v=s.layerId,y=(d=l.getFeatureSQL(m,h))==null?void 0:d[v];if(!y)return[];const w=y.anyVertex;let J=y.endVertex;return J&&w&&J===w&&(J=""),J&&_.push({...c,returnEdge:!1,vertexMode:"ends",filter:$n(c.filter,J)}),w&&_.push({...c,returnEdge:!1,vertexMode:"all",filter:$n(c.filter,w)}),_}return[c]}async loadRules(){var i,s;const{layer:e,view:t}=this;if(e&&t&&Rl(t==null?void 0:t.map)&&yn(e)){const r=(i=t.map.utilityNetworks)==null?void 0:i.find(a=>a.isUtilityLayer(e));if(r)try{this.rulesTable=await r.getRulesTable(),await((s=this.rulesTable)==null?void 0:s.load()),this._valid=!0}catch{return void Gn.getLogger("esri.views.interactive.snapping.FeatureSnappingSourceInfo").error("Failed to load rules table for snapping source",e.title)}}else this._valid=!0}get _types(){return{returnEdge:!0,vertexMode:"all"}}remove(){this.destroy()}destroy(){var e;(e=this.snappingSource)==null||e.destroy()}};function $n(n,e){return n==null?new Wt({where:e}):n.where?new Wt({where:Nn(n.where,e)}):new Wt({where:e})}p([f({constructOnly:!0})],ee.prototype,"layer",void 0),p([f({constructOnly:!0})],ee.prototype,"snappingSource",void 0),p([f({constructOnly:!0})],ee.prototype,"view",void 0),p([f()],ee.prototype,"layerView",null),p([f()],ee.prototype,"rulesTable",void 0),p([f()],ee.prototype,"valid",null),p([f()],ee.prototype,"subtypeFilter",null),p([f()],ee.prototype,"floorFilter",null),p([f()],ee.prototype,"_valid",void 0),ee=p([z("esri.views.interactive.snapping.FeatureSnappingSourceInfo")],ee);let pt=class{constructor(e,t,i,s){this.targetPoint=e,this.constraint=t,this.isDraped=i,this.domain=s}},fi=class extends pt{constructor({targetPoint:e,objectId:t,constraint:i,isDraped:s}){super(e,i,s,A.FEATURE),this.objectId=t}},fc=class extends fi{constructor(e){super({...e,isDraped:!0,constraint:new xr(e.edgeStart,e.edgeEnd,e.getGroundElevation)})}get hints(){return[new Q(N.REFERENCE,this.constraint.start,this.constraint.end,this.isDraped,this.domain)]}},mc=class extends fi{constructor(e){super({...e,constraint:new li(e.edgeStart,e.edgeEnd)})}get hints(){return[new Q(N.REFERENCE,this.constraint.start,this.constraint.end,this.isDraped,this.domain)]}},Mr=class extends pt{constructor({targetPoint:e,constraint:t,previousVertex:i,otherVertex:s,otherVertexType:r,objectId:a,isDraped:l}){super(e,t,l,A.SELF),this.previousVertex=i,this.otherVertex=s,this.otherVertexType=r,this.objectId=a}get hints(){const e=this.previousVertex,t=this.otherVertexType===ct.CENTER?this.otherVertex:this.targetPoint,i=this.otherVertexType===ct.CENTER?this.targetPoint:this.otherVertex;return[new Q(N.TARGET,t,i,this.isDraped,this.domain),new Q(N.REFERENCE,e,t,this.isDraped,this.domain),new ti(this.previousVertex,t,i,this.isDraped,this.domain)]}};var ct;(function(n){n[n.NEXT=0]="NEXT",n[n.CENTER=1]="CENTER"})(ct||(ct={}));let Ee=class extends K{get updating(){return this._snappingSources.some(e=>e==null||e.valid&&e.snappingSource.updating)||this._updatingHandles.updating}constructor(e){super(e),this.options=null,this._domain=A.FEATURE,this._updatingHandles=new ys,this._sourceModules={featureService:{module:null,loader:null},featureCollection:{module:null,loader:null},graphics:{module:null,loader:null},notes:{module:null,loader:null},scene:{module:null,loader:null}}}initialize(){const e=Oa(()=>{var t;return(t=this.options)==null?void 0:t.featureSources},(t,i)=>this._createSourceInfo(t,i));this._snappingSources=e,this.addHandles(re(e))}destroy(){this._set("options",null),this._updatingHandles.destroy()}async fetchCandidates(e,t,i,s){var o;if(!(t&this._domain&&this.options!=null&&this.options.effectiveFeatureEnabled))return[];const r=[],a=this._computeScreenSizeDistanceParameters(e,i);for(const c of this._snappingSources){if(c==null||!c.valid||!c.snappingSource.layerSource.enabled||(o=c.layerView)!=null&&o.suspended)continue;const u=c.getFetchCandidatesParameters(e,i,a);for(const d of u)r.push(c.snappingSource.fetchCandidates(d,s).then(h=>h.filter(m=>!this._candidateIsExcluded(c.snappingSource,m,i.excludeFeature))))}const l=(await Ca(r)).flat();return this._addRightAngleCandidates(l,e,a,i),vn(s),ei(e,l),l}_addRightAngleCandidates(e,t,i,s){var d,h,m,_,v,y,w,J;const r=s.vertexHandle!=null?(h=(d=s.vertexHandle.rightEdge)==null?void 0:d.rightVertex)==null?void 0:h.pos:s.editGeometryOperations!=null&&s.editGeometryOperations.data.type==="polygon"?(_=(m=s.editGeometryOperations.data.components[0])==null?void 0:m.getFirstVertex())==null?void 0:_.pos:null,a=s.vertexHandle!=null?(y=(v=s.vertexHandle.leftEdge)==null?void 0:v.leftVertex)==null?void 0:y.pos:s.editGeometryOperations!=null?(J=(w=s.editGeometryOperations.data.components[0])==null?void 0:w.getLastVertex())==null?void 0:J.pos:null,{view:l}=this,o=M(r,l,s),c=M(a,l,s),u=e.length;for(let le=0;le<u;le++)this._addRightAngleCandidate(e[le],c,t,i,e),this._addRightAngleCandidate(e[le],o,t,i,e)}_addRightAngleCandidate(e,t,i,s,r){if(t==null||!gc(e))return;const a=e.constraint.closestTo(t),l=(a[0]-i[0])/s.x,o=(a[1]-i[1])/s.y,{start:c,end:u}=e.constraint;if(l*l+o*o<=1){const d=new Mr({targetPoint:a,otherVertex:t,otherVertexType:ct.NEXT,previousVertex:Ie(a,c)>Ie(a,u)?c:u,constraint:new wr(t,a),objectId:e.objectId,isDraped:e.isDraped});r.push(d)}}_computeScreenSizeDistanceParameters(e,t){let i=this.options!=null?this.options.distance*(t.pointer==="touch"?this.options.touchSensitivityMultiplier:1):0;return this.view==null?{x:i,y:i,z:i,distance:i}:this.view.type==="2d"?(i*=this.view.resolution,{x:i,y:i,z:i,distance:i}):this._computeScreenSizeDistanceParameters3D(e,i,this.view,t)}_computeScreenSizeDistanceParameters3D(e,t,i,s){const{spatialReference:r}=s;i.renderCoordsHelper.toRenderCoords(e,r,Ji);const a=i.state.camera.computeScreenPixelSizeAt(Ji),l=a*i.renderCoordsHelper.unitInMeters,o=l/Ta(r),c=l/Da(r),u=t*o,d=t*c,h=V(e,r,C,i),m=h?Mn(h,e,o,0,0,i,s):0,_=h?Mn(h,e,0,o,0,i,s):0,v=h?Mn(h,e,0,0,c,i,s):0;return{x:m===0?0:u/m,y:_===0?0:u/_,z:v===0?0:d/v,distance:a*t}}_candidateIsExcluded(e,t,i){if(i==null)return!1;const s=this._getCandidateObjectId(t);if(s==null)return!1;const r=e.layerSource.layer;return r.type==="graphics"?i.uid===s:i.sourceLayer===r&&!(!i.attributes||!("objectIdField"in r))&&i.attributes[r.objectIdField]===s}_getCandidateObjectId(e){return e instanceof fi?e.objectId:null}async _createSourceInfo(e,t){const i=e.layer;i.loaded||(await i.load(),vn(t));const{view:s}=this,r=await this._createFeatureSnappingSourceType(e);return vn(t),new ee(r==null?{}:{snappingSource:r,view:s,layer:i})}async _createFeatureSnappingSourceType(e){switch(e.layer.type){case"feature":case"geojson":case"csv":case"oriented-imagery":case"subtype-group":case"wfs":return this._createFeatureSnappingSourceFeatureLayer(e);case"graphics":return this._createFeatureSnappingSourceGraphicsLayer(e);case"map-notes":return this._createFeatureSnappingSourceMapNotesLayer(e);case"scene":case"building-scene":return this._createFeatureSnappingSourceSceneLayer(e)}return null}async _createFeatureSnappingSourceSceneLayer(e){const{view:t}=this;return t==null||t.type!=="3d"?null:new(await this._getSourceModule("scene")).SceneLayerSnappingSource({layerSource:e,view:t})}async _createFeatureSnappingSourceFeatureLayer(e){var t;switch((t=e.layer.source)==null?void 0:t.type){case"feature-layer":case"oriented-imagery":return new(await this._getSourceModule("featureService")).FeatureServiceSnappingSource({spatialReference:this.spatialReference,view:this.view,layerSource:e});case"memory":case"csv":case"geojson":case"wfs":return e.layer.geometryType==="mesh"?null:new(await this._getSourceModule("featureCollection")).FeatureCollectionSnappingSource({layerSource:e,view:this.view})}return null}async _createFeatureSnappingSourceGraphicsLayer(e){return new(await this._getSourceModule("graphics")).GraphicsSnappingSource({getGraphicsLayers:()=>[e.layer],spatialReference:this.spatialReference,view:this.view,layerSource:e})}async _createFeatureSnappingSourceMapNotesLayer(e){return new(await this._getSourceModule("notes")).GraphicsSnappingSource({getGraphicsLayers:()=>{var t;return((t=e.layer.sublayers)==null?void 0:t.toArray())??[]},spatialReference:this.spatialReference,view:this.view,layerSource:e})}async _getSourceModule(e){const t=this._sourceModules[e];if(t.loader==null){const i=this._loadSourceModule(e),s={module:null,loader:i};this._sourceModules[e]=s;const r=await i,a={module:r,loader:i};return this._sourceModules[e]=a,r}return t.module==null?t.loader:t.module}_loadSourceModule(e){const t=this._updatingHandles;switch(e){case"featureService":return t.addPromise(Rt(()=>import("./FeatureServiceSnappingSource-fcg0Suuo.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19])));case"featureCollection":return t.addPromise(Rt(()=>import("./FeatureCollectionSnappingSource-bBpehqoS.js"),__vite__mapDeps([20,1,2,3,4,5,21,7,8,9,10,11,12,13,14,15,16,17,18,19])));case"graphics":case"notes":return t.addPromise(Rt(()=>import("./GraphicsSnappingSource-ju_o_2OH.js"),__vite__mapDeps([22,1,2,23,24,25,26,27,28,29,30,31,32,33,34,35,36,3,4,5,21,7,8,9,10,11,12,13,14,15,16,17,18,19])));case"scene":return t.addPromise(Rt(()=>import("./SceneLayerSnappingSource-bEgtBvls.js"),__vite__mapDeps([37,1,2,5,7,8,9,10,3,11,12,13,14,15,16,17,18,19])))}}get test(){return{snappingSources:this._snappingSources}}};function gc(n){return(n instanceof mc||n instanceof fc)&&!_c(n)}function _c({constraint:{start:n,end:e}}){const t=Yt(n,e),i=Ie(n,e);return t<Ra()||i/t<vc}function Mn(n,e,t,i,s,r,{spatialReference:a}){const l=L(yc,e);l[0]+=t,l[1]+=i,l[2]+=s;const o=V(l,a,C,r);return o?Cl(o,n):1/0}p([f({constructOnly:!0})],Ee.prototype,"spatialReference",void 0),p([f({constructOnly:!0})],Ee.prototype,"view",void 0),p([f()],Ee.prototype,"options",void 0),p([f({readOnly:!0})],Ee.prototype,"updating",null),p([f()],Ee.prototype,"_snappingSources",void 0),Ee=p([z("esri.views.interactive.snapping.FeatureSnappingEngine")],Ee);const Ji=g(),yc=g(),vc=1e-4;let dn=class{constructor(e,t){this.view=e,this.options=t,this.squaredShortLineThreshold=T.shortLineThreshold*T.shortLineThreshold}snap(e,t){return t.vertexHandle!=null?t.vertexHandle.type!=="vertex"?[]:this.snapExistingVertex(e,t):this.snapNewVertex(e,t)}edgeExceedsShortLineThreshold(e,t){return this.exceedsShortLineThreshold(M(e.leftVertex.pos,this.view,t),M(e.rightVertex.pos,this.view,t),t)}exceedsShortLineThreshold(e,t,{spatialReference:i}){return this.squaredShortLineThreshold===0||Xe(V(t,i,C,this.view),V(e,i,C,this.view))>this.squaredShortLineThreshold}isVertical(e,t){return Ie(e,t)<T.verticalLineThreshold}squaredProximityThreshold(e){return e==="touch"?this._squaredTouchProximityThreshold:this._squaredMouseProximityThreshold}get _squaredMouseProximityThreshold(){return this.options.distance*this.options.distance}get _squaredTouchProximityThreshold(){const{distance:e,touchSensitivityMultiplier:t}=this.options,i=e*t;return i*i}},Sc=class extends pt{constructor({lineStart:e,lineEnd:t,targetPoint:i,isDraped:s}){super(i,new Pr(e,t),s,A.SELF),this._referenceLineHint=new Q(N.REFERENCE_EXTENSION,e,t,s,this.domain)}get hints(){return[this._referenceLineHint,new Q(N.TARGET,this._lineEndClosestToTarget(),this.targetPoint,this.isDraped,this.domain)]}_lineEndClosestToTarget(){return this.constraint.closestEndTo(this.targetPoint)}},wc=class extends dn{snapNewVertex(e,t){const i=t.editGeometryOperations.data.components[0],s=i.edges.length,r=[];if(s<1)return r;const{spatialReference:a}=t,l=V(e,a,C,this.view),{view:o}=this,c=i.edges[s-1];let u=c;do{if(this.edgeExceedsShortLineThreshold(u,t)){const d=nn(u,o,t);this._processCandidateProposal(d.left,d.right,e,l,t,r)}u=u.leftVertex.leftEdge}while(u&&u!==c);return r}snapExistingVertex(e,t){const i=[],s=t.vertexHandle,r=s.component;if(r.edges.length<2)return i;const{view:a}=this,{spatialReference:l}=t,o=V(e,l,C,a),c=s.leftEdge,u=s.rightEdge;c&&u&&this.edgeExceedsShortLineThreshold(c,t)&&this.edgeExceedsShortLineThreshold(u,t)&&this._processCandidateProposal(M(c.leftVertex.pos,a,t),M(u.rightVertex.pos,a,t),e,o,t,i);const d=r.edges[0];let h=d;do{if(h!==s.leftEdge&&h!==s.rightEdge&&this.edgeExceedsShortLineThreshold(h,t)){const m=nn(h,a,t);this._processCandidateProposal(m.left,m.right,e,o,t,i)}h=h.rightVertex.rightEdge}while(h&&h!==d);return i}_processCandidateProposal(e,t,i,s,r,a){var u;const{spatialReference:l,pointer:o}=r,c=ii(i,{start:e,end:t,type:H.LINE});Xe(s,V(c,l,C,this.view))<this.squaredProximityThreshold(o)&&a.push(new Sc({lineStart:e,lineEnd:t,targetPoint:c,isDraped:((u=r.elevationInfo)==null?void 0:u.mode)==="on-the-ground"}))}},Pc=class extends pt{constructor({referenceLine:e,lineStart:t,targetPoint:i,isDraped:s}){const r=Se(t),{left:a,right:l}=e;ke(r,Fn(r,r,l),a),super(i,new Pr(t,r),s,A.SELF),this._referenceLines=[{edge:e,fadeLeft:!0,fadeRight:!0}]}get hints(){return[new Q(N.TARGET,this.constraint.start,this.targetPoint,this.isDraped,this.domain),new er(this.constraint.start,this.targetPoint,this.isDraped,this.domain),...this._referenceLines.map(e=>new Q(N.REFERENCE,e.edge.left,e.edge.right,this.isDraped,this.domain,e.fadeLeft,e.fadeRight))]}addReferenceLine(e){const t={edge:e,fadeLeft:!0,fadeRight:!0};this._referenceLines.forEach(i=>{P(e.right,i.edge.left)&&(i.fadeLeft=!1,t.fadeRight=!1),P(e.right,i.edge.right)&&(i.fadeRight=!1,t.fadeRight=!1),P(e.left,i.edge.right)&&(i.fadeRight=!1,t.fadeLeft=!1),P(e.left,i.edge.left)&&(i.fadeLeft=!1,t.fadeLeft=!1)}),this._referenceLines.push(t)}},xc=class extends dn{snapNewVertex(e,t){const i=t.editGeometryOperations.data.components[0],s=i.edges.length,r=i.vertices.length,a=[];if(s<2)return a;const{view:l}=this,o=V(e,t.spatialReference,C,l),c=M(i.vertices[r-1].pos,l,t),u=M(i.vertices[0].pos,l,t),d=i.edges[s-1];let h=d;do{if(this.edgeExceedsShortLineThreshold(h,t)){const m=nn(h,l,t);this._checkEdgeForParallelLines(m,c,e,o,t,a),this._checkEdgeForParallelLines(m,u,e,o,t,a)}h=h.leftVertex.leftEdge}while(h&&h!==d);return a}snapExistingVertex(e,t){const i=[],s=t.vertexHandle,r=s.component;if(r.edges.length<3)return i;const{view:a}=this,l=V(e,t.spatialReference,C,a),o=s.leftEdge,c=s.rightEdge,u=r.vertices[0],d=M(u.pos,a,t),h=r.vertices.length,m=r.vertices[h-1],_=M(m.pos,a,t),v=r.edges[0];let y=v;do{if(y!==o&&y!==c&&this.edgeExceedsShortLineThreshold(y,t)){const w=nn(y,a,t);o&&this._checkEdgeForParallelLines(w,M(o.leftVertex.pos,a,t),e,l,t,i),c&&this._checkEdgeForParallelLines(w,M(c.rightVertex.pos,a,t),e,l,t,i),s===u?this._checkEdgeForParallelLines(w,_,e,l,t,i):s===m&&this._checkEdgeForParallelLines(w,d,e,l,t,i)}y=y.rightVertex.rightEdge}while(y&&y!==v);return i}_checkEdgeForParallelLines(e,t,i,s,r,a){var h;const l=e.left,o=e.right;if(Sn(je,t,l,o),Ie(je,t)<T.parallelLineThreshold)return;Sn(je,i,l,o,t);const{spatialReference:c,pointer:u}=r,d=Ge(je[0],je[1],i[2]);if(Xe(s,V(d,c,C,this.view))<this.squaredProximityThreshold(u)){if(this.isVertical(d,t)||this.isVertical(l,o)||this._parallelToPreviousCandidate(e,a))return;a.push(new Pc({referenceLine:e,lineStart:t,targetPoint:d,isDraped:((h=r.elevationInfo)==null?void 0:h.mode)==="on-the-ground"}))}}_parallelToPreviousCandidate(e,t){const i=e.left,s=e.right;for(const r of t)if(Sn(je,s,r.constraint.start,r.constraint.end,i),Ie(je,s)<T.parallelLineThreshold)return r.addReferenceLine(e),!0;return!1}};const je=B();let bc=class extends dn{snapNewVertex(e,t){const i=t.editGeometryOperations.data.components[0],s=i.vertices.length,r=[];if(s<2)return r;const{view:a}=this,l=V(e,t.spatialReference,C,a),o=i.vertices[s-1];if(this.edgeExceedsShortLineThreshold(o.leftEdge,t)){const u=M(o.pos,a,t),d=M(o.leftEdge.leftVertex.pos,a,t);this._checkForSnappingCandidate(r,d,u,e,l,t)}const c=i.vertices[0];if(this.edgeExceedsShortLineThreshold(c.rightEdge,t)){const u=M(c.pos,a,t),d=M(c.rightEdge.rightVertex.pos,a,t);this._checkForSnappingCandidate(r,d,u,e,l,t)}return r}snapExistingVertex(e,t){const i=[],s=t.vertexHandle;if(s.component.vertices.length<3)return i;const{view:r}=this,a=V(e,t.spatialReference,C,r),l=s.leftEdge,o=s.rightEdge;if(l!=null&&l.leftVertex.leftEdge){const c=l.leftVertex.leftEdge;if(this.edgeExceedsShortLineThreshold(c,t)){const u=M(c.rightVertex.pos,r,t),d=M(c.leftVertex.pos,r,t);this._checkForSnappingCandidate(i,d,u,e,a,t)}}if(o!=null&&o.rightVertex.rightEdge){const c=o.rightVertex.rightEdge;if(this.edgeExceedsShortLineThreshold(c,t)){const u=M(c.leftVertex.pos,r,t),d=M(c.rightVertex.pos,r,t);this._checkForSnappingCandidate(i,d,u,e,a,t)}}return i}_checkForSnappingCandidate(e,t,i,s,r,a){var h;const{spatialReference:l,pointer:o}=a;ve(Nt,i,t);const c=ne($c,Nt[1],-Nt[0],0),u=Ot(c,ve(Nt,s,i))/wt(c),d=yt(Se(s),i,c,u);if(Xe(r,V(d,l,C,this.view))<this.squaredProximityThreshold(o)){if(this.isVertical(d,i)||this.isVertical(i,t))return;const m=k(g(),i,c,Math.sign(u));e.push(new Mr({targetPoint:d,constraint:new wr(i,m),previousVertex:t,otherVertex:i,otherVertexType:ct.CENTER,isDraped:((h=a.elevationInfo)==null?void 0:h.mode)==="on-the-ground"}))}}};const Nt=B(),$c=g();let Mc=class extends pt{constructor({targetPoint:e,point1:t,point2:i,isDraped:s}){super(e,new Sr(fs(g(),t,i,.5),.5*vs(t,i)),s,A.SELF),this._p1=t,this._p2=i}get hints(){return[new Q(N.REFERENCE,this.targetPoint,this._p1,this.isDraped,this.domain),new Q(N.REFERENCE,this.targetPoint,this._p2,this.isDraped,this.domain),new ti(this._p1,this.targetPoint,this._p2,this.isDraped,this.domain)]}},Ec=class extends dn{snapNewVertex(e,t){const i=t.editGeometryOperations.data.components[0],s=[],r=i.vertices.length;if(t.editGeometryOperations.data.type!=="polygon"||r<2)return s;const{view:a}=this,l=i.vertices[0],o=i.vertices[r-1],c=M(l.pos,a,t),u=M(o.pos,a,t);return this._processCandidateProposal(c,u,e,t,s),s}snapExistingVertex(e,t){const i=[],s=t.vertexHandle,r=s.component;if(r.edges.length<2||t.editGeometryOperations.data.type==="polyline"&&(s.index===0||s.index===r.vertices.length-1))return i;const{view:a}=this,l=M(s.leftEdge.leftVertex.pos,a,t),o=M(s.rightEdge.rightVertex.pos,a,t);return this._processCandidateProposal(l,o,e,t,i),i}_processCandidateProposal(e,t,i,s,r){var m;if(!this.exceedsShortLineThreshold(e,t,s))return;const a=gs(Oc,e,t,.5),l=.5*vs(e,t),o=g();_o(o,i,a,l),o[2]=i[2];const c=o,{spatialReference:u,pointer:d}=s,h=V(i,u,C,this.view);if(Xe(h,V(c,u,C,this.view))<this.squaredProximityThreshold(d)){if(this.isVertical(e,c)||this.isVertical(c,t))return;r.push(new Mc({targetPoint:c,point1:e,point2:t,isDraped:((m=s.elevationInfo)==null?void 0:m.mode)==="on-the-ground"}))}}};const Oc=B();let et=class extends K{constructor(e){super(e),this.updating=!1,this._snappers=new Et,this._domain=A.SELF}initialize(){this._snappers.push(new xc(this.view,this.options),new wc(this.view,this.options),new bc(this.view,this.options),new Ec(this.view,this.options))}set options(e){this._set("options",e);for(const t of this._snappers)t.options=e}async fetchCandidates(e,t,i){if(!(t&this._domain&&this.options.effectiveSelfEnabled))return[];const s=[];for(const r of this._snappers.items)for(const a of r.snap(e,i))s.push(a);return ei(e,s),s}};p([f({readOnly:!0})],et.prototype,"updating",void 0),p([f({constructOnly:!0})],et.prototype,"view",void 0),p([f()],et.prototype,"options",null),et=p([z("esri.views.interactive.snapping.SelfSnappingEngine")],et);function Cc(n,e){return[new et({view:n,options:e}),new Ee({view:n,options:e,spatialReference:n.spatialReference})]}function es(n,e,{z:t,m:i,spatialReference:s,elevationInfo:r}){if(t==null&&i==null){const o=Ae(n[0],n[1],void 0,s);return i!=null&&(o.m=i,o.hasM=!0),o}if(e==null||e.type==="2d"){const o=Ae(n[0],n[1],t,s);return i!=null&&(o.m=i,o.hasM=!0),o}const a=ho(e,n,s,C,r)??0,l=Ae(n[0],n[1],a,s);return i!=null&&(l.m=i,l.hasM=!0),l}let jt=class extends pt{constructor(e,t,i,s){super(e,new dt(e),s,A.ALL),this.first=t,this.second=i}get hints(){return this.first.targetPoint=this.targetPoint,this.second.targetPoint=this.targetPoint,[...this.first.hints,...this.second.hints,new Qs(this.targetPoint,this.isDraped,this.domain)]}},ie=class extends La.EventedMixin(K){constructor(e){super(e),this.options=new ar,this.snappingEnginesFactory=Cc,this._engines=[],this._currentMainCandidate=null,this._currentOtherActiveCandidates=[],this._currentSnappedType=Oe.MAIN}initialize(){this.addHandles([S(()=>{const{effectiveFeatureEnabled:e,effectiveSelfEnabled:t,touchSensitivityMultiplier:i,distance:s}=this.options;return{effectiveFeatureEnabled:e,effectiveSelfEnabled:t,touchSensitivityMultiplier:i,distance:s}},()=>{this.doneSnapping(),this.emit("changed")},Pt),S(()=>this.options,e=>{for(const t of this._engines)t.options=e},Pt),S(()=>({viewReady:this.view.ready,viewSpatialReference:this.view.spatialReference,snappingEnginesFactory:this.snappingEnginesFactory}),({viewReady:e,snappingEnginesFactory:t})=>this._recreateEngines(e,t),F)])}destroy(){this._destroyEngines()}get updating(){return this._engines.some(e=>e.updating)}_recreateEngines(e,t){if(this._destroyEngines(),!e)return;const{view:i,options:s}=this;this._engines=t(i,s)}_destroyEngines(){for(const e of this._engines)e.destroy();this._engines=[]}get _squaredMouseProximityTreshold(){return this.options.distance*this.options.distance}get _squaredTouchProximityThreshold(){const{distance:e,touchSensitivityMultiplier:t}=this.options,i=e*t;return i*i}get _squaredSatisfiesConstraintThreshold(){return T.satisfiesConstraintScreenThreshold*T.satisfiesConstraintScreenThreshold}snap(e){return Tc(e)?this._snapMultiPoint(e):this._snapSinglePoint(e)}update(e){const{point:t,context:i}=e;this._removeVisualization();const s=this._currentMainCandidate;if(s==null)return t;const r=this._selectUpdateInput(e);if(r==null)return t;const{spatialReference:a}=i,l=Di(r,a);if(l==null)return t;const{view:o}=this,{elevationInfo:c,visualizer:u}=i,d=[],h=mt(l,o,c),m=s.constraint.closestTo(h);if(!this._arePointsWithinScreenThreshold(h,m,i))return this._resetSnappingState(),t;s.targetPoint=m,d.push(...s.hints);for(const _ of this._currentOtherActiveCandidates)_.targetPoint=m,d.push(..._.hints);return u!=null&&this.addHandles(u.draw(d,{spatialReference:a,elevationInfo:Dc(i),view:o,selfSnappingZ:i.selfSnappingZ}),qt),es(m,o,{z:t.z,m:t.m,spatialReference:t.spatialReference,elevationInfo:c})}doneSnapping(){this._removeVisualization(),this._resetSnappingState()}_selectUpdateInput({point:e,scenePoint:t}){switch(this._currentSnappedType){case Oe.MAIN:return e;case Oe.SCENE:return t}}_resetSnappingState(){this._currentMainCandidate=null,this._currentOtherActiveCandidates=[],this._currentSnappedType=Oe.MAIN}_removeVisualization(){this.removeHandles(qt)}async _snapSinglePoint({point:e,context:t,signal:i}){const{view:s}=this,{elevationInfo:r}=t,a=mt(e,s,r),l=await this._fetchCandidates(a,A.ALL,t,i);return this._createSnapResult(a,Oe.MAIN,l,s,t,{z:e.z,m:e.m,spatialReference:e.spatialReference,elevationInfo:r},i)}async _snapMultiPoint({point:e,scenePoint:t,context:i,signal:s}){const{view:r}=this,{coordinateHelper:a,elevationInfo:l,spatialReference:o}=i;await Aa(t.spatialReference,o);const c=Di(t,o),u=mt(c,r,l),d=await this._fetchCandidates(u,A.FEATURE,i,s);if(d.length>0){const _=await this._fetchCandidates(u,A.SELF,i,s);return this._createSnapResult(u,Oe.SCENE,[...d,..._],r,i,{z:c.z,m:c.m,spatialReference:c.spatialReference,elevationInfo:l},s)}const h=mt(e,r,l),m=await this._fetchCandidates(h,A.SELF,i,s);return this._createSnapResult(h,Oe.MAIN,m,r,i,{z:a.hasZ()&&e.hasZ?e.z??0:void 0,m:a.hasM()&&e.hasM?e.m??0:void 0,spatialReference:e.spatialReference,elevationInfo:l},s)}async _fetchCandidates(e,t,i,s){return(await Promise.all(this._engines.map(r=>r.fetchCandidates(e,t,i,s)))).flat()}_createSnapResult(e,t,i,s,r,a,l){return{get valid(){return!Ha(l)},apply:()=>{const{spatialReference:o}=r,{snappedPoint:c,hints:u}=this._processCandidates(e,t,i,r);return this._removeVisualization(),r.visualizer!=null&&this.addHandles(r.visualizer.draw(u,{spatialReference:o,elevationInfo:C,view:s,selfSnappingZ:r.selfSnappingZ}),qt),es(c,s,a)}}}_processCandidates(e,t,i,s){if(i.length<1)return this.doneSnapping(),{snappedPoint:e,hints:[]};this._currentSnappedType!==t&&this._resetSnappingState(),ei(e,i);const r=this._currentMainCandidate;if(r!=null){const a=this._findOldConstraintInNewCandidates(r,i);if(a>=0){if(!(i[a]instanceof jt))return this._intersectWithOtherCandidates(a,i,e,t,s);if(this._arePointsWithinScreenThreshold(e,r.targetPoint,s))return this._updateSnappingCandidate(r,t,i,s)}}return this._intersectWithOtherCandidates(0,i,e,t,s)}_findOldConstraintInNewCandidates(e,t){return e instanceof jt?this._findOldCandidateIndex(t,e.first)>=0&&this._findOldCandidateIndex(t,e.second)>=0?0:-1:this._findOldCandidateIndex(t,e)}_intersectWithOtherCandidates(e,t,i,s,r){const{coordinateHelper:a}=r,l=t[e],o=[];for(let c=0;c<t.length;++c){if(c===e)continue;const u=t[c],d=l.constraint.intersect(u.constraint);if(d)for(const h of d.closestPoints(l.targetPoint))o.push([new jt(h,l,u,u.isDraped),this._squaredScreenDistance(i,h,a)])}return o.length>0&&(o.sort((c,u)=>c[1]-u[1]),o[0][1]<this._squaredPointProximityThreshold(r.pointer))?this._updateSnappingCandidate(o[0][0],s,t,r):this._updateSnappingCandidate(l,s,t,r)}_updateSnappingCandidate(e,t,i,s){this.doneSnapping(),this._currentMainCandidate=e,this._currentSnappedType=t;const r=this._currentMainCandidate.targetPoint,a=[];a.push(...e.hints);for(const l of i){if(e instanceof jt){if(l.constraint.equals(e.first.constraint)||l.constraint.equals(e.second.constraint))continue}else if(l.constraint.equals(e.constraint))continue;const o=l.constraint.closestTo(r);this._squaredScreenDistance(o,r,s.coordinateHelper)<this._squaredSatisfiesConstraintThreshold&&(l.targetPoint=r,this._currentOtherActiveCandidates.push(l),a.push(...l.hints))}return{snappedPoint:r,hints:a}}_squaredPointProximityThreshold(e){return e==="touch"?this._squaredTouchProximityThreshold:this._squaredMouseProximityTreshold}_arePointsWithinScreenThreshold(e,t,i){return this._squaredScreenDistance(e,t,i.coordinateHelper)<this._squaredPointProximityThreshold(i.pointer)}_squaredScreenDistance(e,t,i){return Xe(this._toScreen(e,i),this._toScreen(t,i))}_toScreen(e,t){return V(e,t.spatialReference,C,this.view)}_findOldCandidateIndex(e,t){let i=-1;for(let s=0;s<e.length;++s)if(t.constraint.equals(e[s].constraint)){i=s;break}return i}get test(){return{visualizationsActive:this.hasHandles(qt),engines:this._engines}}};var Oe;p([f({constructOnly:!0})],ie.prototype,"view",void 0),p([f()],ie.prototype,"options",void 0),p([f({readOnly:!0})],ie.prototype,"updating",null),p([f()],ie.prototype,"snappingEnginesFactory",void 0),p([f()],ie.prototype,"_engines",void 0),p([f()],ie.prototype,"_squaredMouseProximityTreshold",null),p([f()],ie.prototype,"_squaredTouchProximityThreshold",null),p([f()],ie.prototype,"_squaredSatisfiesConstraintThreshold",null),ie=p([z("esri.views.interactive.snapping.SnappingManager")],ie),function(n){n[n.MAIN=0]="MAIN",n[n.SCENE=1]="SCENE"}(Oe||(Oe={}));const qt="visualization-handle";function Tc(n){return n.scenePoint!=null}function Dc({coordinateHelper:n,elevationInfo:e}){return n.hasZ()?C:e}const Zt=new Map;function Rc(n){if(!Zt.has(n)){const i=Gl(n,{distance:10}),s=Ac(n,i.options);Zt.set(n,{referenceCount:0,snappingManager:s,remove:()=>{i.remove(),s.destroy()}})}const e=Zt.get(n);e.referenceCount++;const t=jn(()=>Lc(n,e));return{snappingManager:e.snappingManager,...t}}function Lc(n,e){e.referenceCount--,e.referenceCount>0||za(()=>{e.referenceCount===0&&(e.remove(),Zt.delete(n))})}function Ac(n,e){return new ie({view:n,options:e,snappingEnginesFactory:(t,i)=>[new Ee({view:n,spatialReference:n.spatialReference,options:i})]})}class Er{constructor(e){this.vertexHandle=null,this.excludeFeature=null,this.visualizer=null,this.selfSnappingZ=null,this.editGeometryOperations=e.editGeometryOperations,this.elevationInfo=e.elevationInfo,this.pointer=e.pointer,this.vertexHandle=e.vertexHandle,this.excludeFeature=e.excludeFeature,this.feature=e.feature,this.visualizer=e.visualizer,this.selfSnappingZ=e.selfSnappingZ}get coordinateHelper(){return this.editGeometryOperations.data.coordinateHelper}get spatialReference(){return this.coordinateHelper.spatialReference}}function Hc({predicate:n=()=>!0,snappingManager:e,snappingContext:t,updatingHandles:i,useZ:s=!0}){const r=new Os;if(e==null)return{snappingStep:[ts,r],cancelSnapping:ts};let a,l=null,o=null,c=null;const u=()=>{l=xt(l),e.doneSnapping(),o==null||o.frameTask.remove(),o=null,a=qn(a),c=null},d=zc(e,s,r);let h=null,m=null,_=null;return{snappingStep:[v=>{if(!n(v))return v;const{action:y}=v;if(y==="start"){const{info:w}=v,J=Vc(e.view);if(o=Ic(t,v,J),o.context.selfSnappingZ=null,!s&&w!=null){const le=kc(t.coordinateHelper,w.handle.component);le!=null&&(o.context.selfSnappingZ={value:le,elevationInfo:t.elevationInfo??C})}}if(o!=null){const{context:w,originalScenePos:J,originalPos:le}=o,{mapEnd:mi,mapStart:gi,scenePoints:Tr}=v,pn=Or(le,zn(mi,gi)),_i=zn(gi,le),Dr={...v,action:"update"},Rr=o.context,hn=Gc(J,Tr),yi=e.update({point:pn,scenePoint:hn,context:w});if(_=yi,Cr(mi,yi,_i,s),h=pn,m=hn,y!=="end"){const{frameTask:Lr}=o;l==null&&(l=new AbortController),c=Ar=>{i.addPromise(Rn(d({frameTask:Lr,event:Dr,context:Rr,point:pn,scenePoint:hn,delta:_i,getLastState:()=>({point:h,scenePoint:m,updatePoint:Ar.forceUpdate?null:_})},l.signal)))},c({forceUpdate:!1}),a==null&&(a=S(()=>e.options.effectiveEnabled,()=>c==null?void 0:c({forceUpdate:!0})))}}return y==="end"&&u(),v},r],cancelSnapping:v=>(u(),v)}}function zc(n,e,t){return Ps(async({frameTask:i,point:s,scenePoint:r,context:a,event:l,delta:o,getLastState:c},u)=>{const d=await i.schedule(()=>n.snap({point:s,scenePoint:r,context:a,signal:u}),u);if(d.valid){let h=await i.schedule(()=>d.apply(),u);const m=c();m.point!=null&&s!==m.point&&(h=n.update({point:m.point,scenePoint:m.scenePoint,context:a})),m.updatePoint!=null&&Po(h,m.updatePoint)||(Cr(l.mapEnd,h,o,e),t.execute(l))}})}function Vc(n){return n.type==="3d"?n.resourceController.scheduler.registerTask(Ss.SNAPPING):ws}function Ic(n,e,t){return{context:new Er({editGeometryOperations:n.editGeometryOperations,elevationInfo:n.elevationInfo,pointer:n.pointer,vertexHandle:e.info!=null?e.info.handle:null,excludeFeature:n.excludeFeature,feature:n.feature,visualizer:n.visualizer}),originalPos:e.snapOrigin!=null?n.coordinateHelper.vectorToDehydratedPoint(e.snapOrigin):e.mapStart,originalScenePos:e.scenePoints!=null?e.scenePoints.sceneStart:null,frameTask:t}}function Or(n,[e,t,i]){const s=nt(n);return s.x+=e,s.y+=t,s.hasZ&&(s.z+=i),s}function Gc(n,e){return n==null||e==null?null:Or(n,zn(e.sceneEnd,e.sceneStart))}function zn(n,e){const t=n.hasZ&&e.hasZ?n.z-e.z:0;return[n.x-e.x,n.y-e.y,t]}function Cr(n,e,[t,i,s],r){n.x=e.x+t,n.y=e.y+i,r&&n.hasZ&&e.hasZ&&(n.z=e.z+s)}function kc(n,e){if(!n.hasZ())return null;const t=e.vertices;let i=null;for(const s of t){const r=n.getZ(s.pos);if(i!=null&&r!=null&&Math.abs(r-i)>1e-6)return null;i==null&&(i=r)}return i}function ts(n){return n}let Ze=class extends K{constructor(n){super(n),this.constrainResult=e=>e,this._snapPoints=null,this._frameTask=null,this._abortController=null,this._stagedPoint=null,this._snap=Ps(async(e,t,i,s)=>{const r=this._frameTask;if(r==null)return;const a=await r.schedule(()=>t.snap({...e,context:i,signal:s}),s);a.valid&&await r.schedule(()=>{this.stagedPoint=a.apply(),e!==this._snapPoints&&this._snapPoints!=null&&(this.stagedPoint=t.update({...this._snapPoints,context:i}))},s)})}get stagedPoint(){return this._stagedPoint}set stagedPoint(n){this._stagedPoint=this.constrainResult(n)}initialize(){var e,t;const n=this.view.type==="3d"?(t=(e=this.view)==null?void 0:e.resourceController)==null?void 0:t.scheduler:null;this._frameTask=n!=null?n.registerTask(Ss.SNAPPING):ws}destroy(){this._abortController=xt(this._abortController),this._frameTask=qn(this._frameTask)}update(n,e,t){this._snapPoints=n;const{point:i,scenePoint:s}=n,r=e.update({point:i,scenePoint:s,context:t});return this.stagedPoint=r,r}async snap(n,e,t){const{point:i,scenePoint:s}=n;return this.stagedPoint=e.update({point:i,scenePoint:s,context:t}),this._snapPoints=n,this._abortController==null&&(this._abortController=new AbortController),this._snap(n,e,t,this._abortController.signal)}async resnap(n,e){this._snapPoints!=null&&await this.snap(this._snapPoints,n,e)}abort(){this._abortController=xt(this._abortController),this._snapPoints=null}};p([f({constructOnly:!0})],Ze.prototype,"view",void 0),p([f()],Ze.prototype,"stagedPoint",null),p([f()],Ze.prototype,"constrainResult",void 0),p([f()],Ze.prototype,"_stagedPoint",void 0),Ze=p([z("esri.views.interactive.snapping.SnappingOperation")],Ze);let G=class extends K{constructor(n){super(n),this._stagedDimension=null,this._computationManipulators=new Map,this._computationHandles=new xs,this._orientationManipulatorTexture=null,this._updatingHandles=new ys,this._getSnappingContext=yl(i=>new Er({elevationInfo:{mode:"absolute-height",offset:0},pointer:i,editGeometryOperations:new yo(new vo("point",So(!0,!1,this.view.spatialReference))),visualizer:new Hl}));const{view:e}=n;this._snappingManagerResult=Rc(e),this.addHandles(this._snappingManagerResult),this._unfocusedOffsetManipulatorMaterial=this._createOffsetManipulatorMaterial(),this._focusedOffsetManipulatorMaterial=this._createOffsetManipulatorMaterial(),this._thinOffsetManipulatorMaterial=this._createOffsetManipulatorMaterial(),this._thinOffsetManipulatorMaterial.setParameters({stipplePattern:Xt(2)}),this._constraintSnappingIndicator=new qe({view:e,attached:!0,width:1,renderOccluded:x.OccludeAndTransparent,stipplePattern:Xt(5),isDecoration:!0});const t=X.toUnitRGBA(Vo);this._stagedStartIndicator=new Vl({view:e,attached:!1,elevationInfo:{mode:"absolute-height",offset:0},spatialReference:n.view.renderCoordsHelper.spatialReference,color:t,size:2*ks,outlineSize:0,renderOccluded:x.OccludeAndTransparent,isDecoration:!0})}initialize(){var i;const{view:n}=this;this._snappingOperation=new Ze({view:n});const e=!((i=n._stage)!=null&&i.renderView.renderingContext.driverTest.svgPremultipliesAlpha.result);this._orientationManipulatorMaterial=new Ts({transparent:!0,writeDepth:!1,renderOccluded:x.Opaque,isDecoration:!0}),this.addHandles(S(()=>({accentColor:en(n.effectiveTheme),contrastColor:zo(n.effectiveTheme)}),({accentColor:s,contrastColor:r})=>{const a=this._orientationManipulatorTexture,l=uo(n.textures,{accentColor:s,contrastColor:r,preMultiplyAlpha:e});this._orientationManipulatorMaterial.setParameters({textureId:l.texture.id}),this._orientationManipulatorTexture=l,a==null||a.release();const o=X.toUnitRGBA(s);this._unfocusedOffsetManipulatorMaterial.setParameters({color:o}),this._focusedOffsetManipulatorMaterial.setParameters({color:o}),this._thinOffsetManipulatorMaterial.setParameters({color:o}),this._constraintSnappingIndicator.color=o},ot));const t=on(()=>this.analysisViewData.computations,({computation:s})=>this._createManipulators(s));this.addHandles(re(t)),this.addHandles([S(()=>({stagedPoint:this._snappingOperation.stagedPoint,stagedComputation:this._stagedComputation}),({stagedPoint:s,stagedComputation:r})=>{if(r==null||s==null)return;const a=nt(s,new it);this._applyPointUpdate(r,{endPoint:a})},Pt),S(()=>({stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,firstGrabbedManipulator:this.firstGrabbedManipulator}),(s,r)=>{const{stagedDimension:a,selectedComputation:l,firstGrabbedManipulator:o}=s;if(a===(r==null?void 0:r.stagedDimension)&&o===(r==null?void 0:r.firstGrabbedManipulator)){for(const c of[l,r==null?void 0:r.selectedComputation])if(c!=null){const u=this._computationManipulators.get(c);u!=null&&this._updateManipulators(c,u,s)}}else for(const[c,u]of this._computationManipulators)this._updateManipulators(c,u,s)},F),S(()=>this.analysis.style.lineSize,s=>{this._updateManipulatorStyle(s)},ot),S(()=>this.view.state.camera,()=>{this._stagedComputation!=null&&this._updateStagedDimensionOffset(this._stagedComputation)}),S(()=>{const s=this._stagedComputation;if(!s)return null;const r=s.elevationAlignedStartPoint,a=g();return r!=null&&this.view.renderCoordsHelper.toRenderCoords(r,a)?a:null},s=>{s!=null?(this._stagedStartIndicator.vertices=[s],this._stagedStartIndicator.attached=!0):this._stagedStartIndicator.attached=!1})]),this.addHandles(this._constraintHandles),this.addHandles(this._snappingIndicatorHandles),Dl(this,()=>{const s=this._activeComputation,r=this._stagedComputation;if(s==null||r!=null){const a=this.view.inputManager.latestPointerType??"mouse",l=this._getSnappingContext(a);this._updatingHandles.addPromise(Rn(this._snappingOperation.resnap(this._snappingManager,l)))}if(s!=null){const{start:a,end:l}=this._computationManipulators.get(s);if(a.grabbing||l.grabbing){const o=a.grabbing?"start":"end",c=this._computeConstraint(s);Pl(s,o,{constraint:c,view:this.view})}}})}destroy(){var n;this._snappingOperation=Un(this._snappingOperation),this._computationHandles.destroy(),this._constraintSnappingIndicator.destroy(),this._stagedStartIndicator.destroy(),(n=this._orientationManipulatorTexture)==null||n.release()}get updating(){return this._updatingHandles.updating||this._snappingManager.updating}get firstGrabbedManipulator(){return this.parentTool.firstGrabbedManipulator}get hasGrabbedManipulators(){return this.parentTool.hasGrabbedManipulators}get snappingOptions(){return this._snappingManager.options}get _snappingManager(){return this._snappingManagerResult.snappingManager}get _activeComputation(){if(this._stagedComputation!=null)return this._stagedComputation;const{selectedComputation:n}=this.analysisViewData;return this.hasGrabbedManipulators&&n!=null?n:null}get _stagedComputation(){var t;const n=this._stagedDimension,e=(t=this.analysisViewData.computations.at(-1))==null?void 0:t.computation;return n==null||e==null||e.dimension!==n?null:e}get _constraintHandles(){return[Wn(()=>this.analysisViewData.selectedComputation,n=>{n.previousConstraint=this._computeConstraint(n)},{...F,equals:Ln}),S(()=>{const n=this._activeComputation;if(n==null)return null;const{measureType:e,orientation:t}=n.dimension;return{measureType:e,orientation:t,computation:n}},(n,e)=>{if(n!=null&&e==null){const{measureType:t,orientation:i,computation:s}=n;switch(s.previousConstraint){case te.Horizontal:s.preConstraintProperties={measureType:E.Horizontal,orientation:0};break;case te.Vertical:s.preConstraintProperties={measureType:E.Vertical,orientation:0};break;case te.Direct:s.preConstraintProperties={measureType:E.Direct,orientation:i};break;default:s.preConstraintProperties={measureType:t,orientation:i}}}n==null&&e!=null&&(e.computation.preConstraintProperties=null)},Pt)]}get _snappingIndicatorHandles(){const n="snapping-indicator-event-handles";return[S(()=>({stagedComputation:this._stagedComputation,activeComputation:this._activeComputation}),({stagedComputation:e,activeComputation:t})=>{const i=this._constraintSnappingIndicator;if(this.removeHandles(n),t!=null)if(t===e)i.attached=!0;else{const{start:s,end:r}=this._computationManipulators.get(t),a=()=>{i.attached=s.grabbing||r.grabbing};a(),this.addHandles([s.events.on("grab-changed",a),r.events.on("grab-changed",a)],n)}else i.attached=!1}),S(()=>{const e=this._activeComputation;return e!=null?{geometry:e.geometry,constraint:e.previousConstraint}:{}},({geometry:e,constraint:t})=>{const i=this._constraintSnappingIndicator;e!=null&&t!=null&&t!==te.Direct?(i.visible=!0,i.setGeometryFromSegment(e.directSegment)):i.visible=!1})]}removeStaged(){return this._stagedDimension!=null&&(this.analysis.dimensions.remove(this._stagedDimension),this._stagedDimension=null,!0)}onDeactivate(){this.removeStaged(),this._resetSnappingState()}onClick(n){const{_stagedDimension:e}=this;if(e==null){const t=this._onUnstagedClick(n);return this.analysis.dimensions.add(t),null}return this._onStagedClick(n),e}onPointerMove({mapPoint:n,pointerType:e}){if(e==="touch")return;const t=this._getSnappingContext(e);this._updatingHandles.addPromise(Rn(this._snappingOperation.snap({point:n},this._snappingManager,t)))}onManipulatorSelectionChanged(){this.analysisViewData.selectedComputation!=null&&(this._computationManipulators.get(this.analysisViewData.selectedComputation).offset.selected||(this.analysisViewData.selectedDimension=null))}_onUnstagedClick({mapPoint:n,pointerType:e}){let t=n;if(e==="mouse"){const s=this._getSnappingContext(e);t=this._snappingManager.update({point:n,context:s})}const i=new Qa({startPoint:nt(t,new it),endPoint:null,measureType:E.Horizontal});return this._stagedDimension=i,this._resetSnappingState(),i}_onStagedClick({mapPoint:n,pointerType:e}){const t=this._stagedComputation;if(t==null)return;let i=n;if(e==="mouse"){const r=this._getSnappingContext(e);i=this._snappingManager.update({point:n,context:r})}const s=nt(i,new it);this._applyPointUpdate(t,{endPoint:s}),this._stagedDimension=null,this._resetSnappingState()}_resetSnappingState(){this._snappingManager.doneSnapping(),this._snappingOperation.abort(),this._snappingOperation.stagedPoint=null}_createManipulators(n){const e=this._setupPointManipulator(n,{isStart:!0}),t=this._setupPointManipulator(n,{isStart:!1}),i=this._setupOffsetManipulator(n),s=this._setupHeadingManipulator(n),r=this._setupRotationManipulator(n),a=this._setupMeasureTypeManipulator(n,E.Direct),l=this._setupMeasureTypeManipulator(n,E.Horizontal),o=this._setupMeasureTypeManipulator(n,E.Vertical),c=new Qo({start:e,end:t,offset:i,heading:s,rotation:r,direct:a,horizontal:l,vertical:o});return this._setupComputationToManipulatorsSync(n,c),this._computationManipulators.set(n,c),this.manipulators.addMany(c.values()),{manipulators:c,remove:()=>{this._computationHandles.remove(n),this._computationManipulators.delete(n);for(const u of c.values())this.manipulators.remove(u)}}}_setupComputationToManipulatorsSync(n,e){this._computationHandles.add([S(()=>n.geometry,()=>this._updateManipulators(n,e),{...F,equals:Ln})],n)}_setupPointManipulator(n,e){const{view:t}=this,{dimension:i}=n,s=new Ko(t,{metadata:i}),r=tl(s,{isStart:e.isStart,createSnappingPipelineStep:a=>Hc({snappingContext:this._getSnappingContext(a),snappingManager:this._snappingManager,updatingHandles:this._updatingHandles}),dimension:i,onUpdate:a=>this._applyPointUpdate(n,a),view:t});return this._computationHandles.add(r,n),s}_setupOffsetManipulator(n){const{view:e}=this,t=Jo(e,{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,metadata:n.dimension}),i=nl(t,{computation:n,view:e});return this._computationHandles.add(i,n),t}_setupHeadingManipulator(n){const{view:e}=this,t=new Vi(e,{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,metadata:n.dimension}),i=il(t,{computation:n,view:e});return this._computationHandles.add(i,n),t}_setupRotationManipulator(n){const{view:e}=this,t=new Vi(e,{lineSizePt:this.analysis.style.lineSize,material:this._orientationManipulatorMaterial,metadata:n.dimension}),i=sl(t,{computation:n,view:e});return this._computationHandles.add(i,n),t}_setupMeasureTypeManipulator(n,e){const{view:t}=this,i=el(t,{lineSizePt:this.analysis.style.lineSize,unfocusedMaterial:this._unfocusedOffsetManipulatorMaterial,focusedMaterial:this._focusedOffsetManipulatorMaterial,thinOffsetManipulatorMaterial:this._thinOffsetManipulatorMaterial,metadata:n.dimension}),s=ol(i,{computation:n,manipulatorMeasureType:e,view:t});return this._computationHandles.add(s,n),i}_updateManipulators(n,e,t={stagedDimension:this._stagedDimension,selectedComputation:this.analysisViewData.selectedComputation,firstGrabbedManipulator:this.firstGrabbedManipulator}){const{stagedDimension:i,selectedComputation:s,firstGrabbedManipulator:r}=t,{start:a,end:l,offset:o,heading:c,rotation:u}=e,d=s===n,h=$t(n),{dimension:m}=n;for(const y of e.values()){const w=h&&i==null&&(r==null||y===r);y===o?(y.available=w,y.selected=d):y.available=w&&d}if(!h)return;this._computeConstraint(n)!=null?e.forEachMeasureTypeManipulator(y=>y.available=!1):e.manipulatorForMeasureType(m.measureType).available=!1;for(const y of[c,u])m.measureType===E.Direct&&m.offset!==0||(y.available=!1);Xn(n)?u.available=!1:c.available=!1;const{geometry:_}=n;a.renderLocation=_.directSegment.startRenderSpace,l.renderLocation=_.directSegment.endRenderSpace;const{renderCoordsHelper:v}=this.view;ll(o,_,v),c.available&&cl(c,n,v),u.available&&ul(u,n,v),e.forEachMeasureTypeManipulator((y,w)=>{y.available&&hl(y,n,w,v)})}_updateManipulatorStyle(n){const e=_l(n),t=Jn(n),i={lineSizePt:n,material:this._orientationManipulatorMaterial};for(const{offset:s,heading:r,rotation:a}of this._computationManipulators.values())s.radius=t/2,r.update(i),a.update(i);this._unfocusedOffsetManipulatorMaterial.setParameters({width:e}),this._focusedOffsetManipulatorMaterial.setParameters({width:t})}_applyPointUpdate(n,e){const{view:t}=this,i=Kt(n);"startPoint"in e&&(i.elevationAlignedStartPoint=e.startPoint),"endPoint"in e&&(i.elevationAlignedEndPoint=e.endPoint);const s=Jt(i,t.renderCoordsHelper);if(s==null)return;const r=this._computeConstraint({...i,geometry:s});Xs(n,e,{...i,constraint:r,unconstrainedGeometry:s,view:t}),n===this._stagedComputation&&this._updateStagedDimensionOffset(n)}_updateStagedDimensionOffset(n){if(n.geometry==null)return;n.geometry.directSegment.eval(.5,ns);const e=this.view.state.camera.computeScreenPixelSizeAt(ns);n.dimension.offset=Yo*e}_computeConstraint(n){return wl(Sl(n,this._snappingManager.options),this.view)}_createOffsetManipulatorMaterial(){return new ge({width:1,renderOccluded:x.OccludeAndTransparent,writeDepth:!1,hasPolygonOffset:!0,isDecoration:!0})}get testInfo(){const n=e=>{var t;return(t=this.analysisViewData.computations.find(({computation:i})=>i.dimension===e))==null?void 0:t.computation};return{disableManipulatorPartialOcclusion:()=>{this._stagedStartIndicator.renderOccluded=x.Occlude,this.manipulators.forEach(({manipulator:e})=>{for(const{geometry:t}of e.renderObjects)t.material.setParameters({renderOccluded:x.Occlude})})},getManipulatorsForDimension:e=>this._computationManipulators.get(n(e)),getComputationForDimension:e=>n(e),getConstraintForDimension:e=>{const t=n(e);return t!=null?this._computeConstraint(t):null},stagedDimension:this._stagedDimension,stagedStartIndicator:this._stagedStartIndicator,constraintSnappingIndicator:this._constraintSnappingIndicator,snappingManager:this._snappingManager}}};p([f({constructOnly:!0})],G.prototype,"analysis",void 0),p([f({constructOnly:!0})],G.prototype,"analysisViewData",void 0),p([f({constructOnly:!0})],G.prototype,"manipulators",void 0),p([f({constructOnly:!0})],G.prototype,"parentTool",void 0),p([f({constructOnly:!0,nonNullable:!0})],G.prototype,"view",void 0),p([f({readOnly:!0})],G.prototype,"updating",null),p([f()],G.prototype,"firstGrabbedManipulator",null),p([f()],G.prototype,"hasGrabbedManipulators",null),p([f()],G.prototype,"snappingOptions",null),p([f()],G.prototype,"_stagedDimension",void 0),p([f()],G.prototype,"_activeComputation",null),p([f()],G.prototype,"_stagedComputation",null),G=p([z("esri.views.3d.analysis.Dimension.LengthDimensionSubTool")],G);const ns=g();var tt;(function(n){n.Ready="ready",n.Creating="creating",n.Created="created"})(tt||(tt={}));let W=class extends ro{constructor(n){super(n),this.automaticManipulatorSelection=!1,this.removeIncompleteOnCancel=!1,this._pointerMoveTimerMs=Bo,this._prevPointerMoveTimeout=null}initialize(){this._intersector=Va(this.view.state.viewingMode),this._intersector.options.store=Ia.MIN,this._lengthDimensionSubTool=new G({analysis:this.analysis,analysisViewData:this.analysisViewData,manipulators:this.manipulators,parentTool:this,view:this.view}),this.addHandles([re(this._lengthDimensionSubTool),jn(()=>this._clearPointerMoveTimeout()),S(()=>this.state,n=>{n===tt.Created&&this.finishToolCreation()},F),Wn(()=>this.firstGrabbedManipulator,n=>{this.selectedDimension=n.metadata},F),S(()=>this.selectedDimension,()=>this._resetPointerMoveTimeout(),F)])}get state(){return this.analysis.dimensions.some(n=>n.type==="length")?this._activeSubTool!=null?tt.Creating:tt.Created:tt.Ready}get updating(){return this._lengthDimensionSubTool.updating}get cursor(){return this.active?"crosshair":null}get selectedDimension(){return this.analysisViewData.selectedDimension}set selectedDimension(n){this.analysisViewData.selectedDimension=n}onInputEvent(n){switch(n.type){case"immediate-click":this._clickHandler(n);break;case"immediate-double-click":this._doubleClickHandler(n);break;case"pointer-move":this._pointerMoveHandler(n);break;case"key-down":if(Wi.cancel===n.key){if(this._activeSubTool!=null&&this._activeSubTool.removeStaged())return void n.stopPropagation();this.active||(this.selectedDimension=null)}else Wi.delete.includes(n.key)&&this._deleteKeyHandler()}}onActivate(){this._activeSubTool=this._lengthDimensionSubTool}onDeactivate(){this._activeSubTool!=null&&(this._activeSubTool.onDeactivate(),this._activeSubTool=null)}onShow(){this._resetPointerMoveTimeout()}onManipulatorSelectionChanged(){this._lengthDimensionSubTool.onManipulatorSelectionChanged()}onHide(){this.selectedDimension=null}_clickHandler(n){if(this.hasFocusedManipulators)return void n.stopPropagation();if(this._activeSubTool==null)return;const e=this._intersectScreen(n);e!=null&&(this.selectedDimension=this._activeSubTool.onClick({mapPoint:e,pointerType:n.pointerType}),n.stopPropagation())}_doubleClickHandler(n){this.active&&(this.view.activeTool=null,n.stopPropagation())}_pointerMoveHandler(n){if(this._resetPointerMoveTimeout(),this._activeSubTool==null||this.hasFocusedManipulators)return;const e=this._intersectScreen(n);e!=null&&this._activeSubTool.onPointerMove({mapPoint:e,pointerType:n.pointerType})}_deleteKeyHandler(){this._activeSubTool!=null&&this._activeSubTool.removeStaged(),this._removeSelected()}_intersectScreen(n){const e=Ga(n);this.view.sceneIntersectionHelper.intersectToolIntersectorScreen(e,this._intersector);const t=this._intersector.results.min,i=b.get();return t.getIntersectionPoint(i)?this.view.renderCoordsHelper.fromRenderCoords(i,this.view.spatialReference):null}_removeSelected(){this.selectedDimension!=null&&(this.analysis.dimensions.remove(this.selectedDimension),this.selectedDimension=null)}_clearPointerMoveTimeout(){this._prevPointerMoveTimeout=qn(this._prevPointerMoveTimeout)}_resetPointerMoveTimeout(){this._clearPointerMoveTimeout(),this.manipulators.forEach(n=>n.manipulator.state|=Te),this._prevPointerMoveTimeout=ka.setTimeout(()=>{this.manipulators.forEach(n=>n.manipulator.state&=~Te)},this._pointerMoveTimerMs)}get testInfo(){return{...this._lengthDimensionSubTool.testInfo,setManipulatorAutoHideDelay:n=>{this._pointerMoveTimerMs=n,this._resetPointerMoveTimeout()}}}};p([f({constructOnly:!0})],W.prototype,"view",void 0),p([f({constructOnly:!0})],W.prototype,"analysis",void 0),p([f({readOnly:!0})],W.prototype,"state",null),p([f({readOnly:!0})],W.prototype,"updating",null),p([f({readOnly:!0})],W.prototype,"cursor",null),p([f({constructOnly:!0})],W.prototype,"analysisViewData",void 0),p([f()],W.prototype,"selectedDimension",null),p([f()],W.prototype,"automaticManipulatorSelection",void 0),p([f()],W.prototype,"_activeSubTool",void 0),p([f()],W.prototype,"_lengthDimensionSubTool",void 0),W=p([z("esri.views.3d.analysis.Dimension.DimensionTool")],W);class Fc extends $s{constructor(e,t){super(e),this._hasExternalMaterial=!1,this._renderOccluded=x.OccludeAndTransparent,this._width=1,this._color=Qt(1,0,1,1),this._placement="end",this._markerPrimitive="arrow",this._material=t,this._hasExternalMaterial=t!=null,this.applyProperties(e)}setGeometryFromSegment(e,t){const i=e.endRenderSpace;this.transform=Fa(Nc,i),this._normal=t;const{points:s}=e.createRenderGeometry(i,this.view.renderCoordsHelper);this.geometry=[s]}get renderOccluded(){return this._material!=null?this._material.parameters.renderOccluded:this._renderOccluded}set renderOccluded(e){this._renderOccluded=e,this._material!=null&&this._material.setParameters({renderOccluded:e})}get geometry(){return this._geometry}set geometry(e){this._geometry=e,this.recreateGeometry()}get normal(){return this._normal}set normal(e){this._normal=e,this.recreateGeometry()}get width(){return this._material!=null?this._material.parameters.width:this._width}set width(e){this._width=e,this._material!=null&&this._material.setParameters({width:e})}get color(){return this._material!=null?this._material.parameters.color:this._color}set color(e){this._color=Rs(e),this._material!=null&&this._material.setParameters({color:this._color})}get placement(){return this._material!=null?this._material.parameters.placement:this._placement}set placement(e){this._placement=e,this._material!=null&&this._material.setParameters({placement:this._placement})}get markerPrimitive(){var e;return((e=this._material)==null?void 0:e.parameters.markerPrimitive)??this._markerPrimitive}set markerPrimitive(e){this._markerPrimitive=e,this._material!=null&&this._material.setParameters({markerPrimitive:e})}createExternalResources(){this._hasExternalMaterial||(this._material=new bs({width:this._width,color:this._color,placement:this._placement,renderOccluded:this._renderOccluded,markerPrimitive:this._markerPrimitive,isDecoration:this.isDecoration}))}destroyExternalResources(){this._hasExternalMaterial||(this._material=null)}createGeometries(e){for(const t of Na(this.geometry,this.normal)){const i=ja(this._material,t);e.addGeometry(i)}}forEachExternalMaterial(e){this._hasExternalMaterial||e(this._material)}}const Nc=In();let jc=class{set visible(e){for(const t of this._visualElements.values())t.attached=e}constructor(e){this.destroyed=!1,this._handles=new xs,this._messages=null,this._labelSegment=new Ye;const{analysis:t,computation:i,view:s,messages:r,isDecoration:a}=e;this.analysis=t,this.computation=i,this.view=s,this._messages=r;const l=e.visible,o={view:s,attached:l,isDecoration:a},{fontSize:c,textColor:u,textBackgroundColor:d}=t.style;this._visualElements=new Zc({marker:new Fc(o,e.markerMaterial),dimension:new qe(o,e.dimensionLineMaterial),startOffset:new qe(o,e.offsetLineMaterial),endOffset:new qe(o,e.offsetLineMaterial),dimensionSmall:new qe(o,e.smallDimensionLineMaterial),startOffsetSmall:new qe(o,e.smallOffsetLineMaterial),endOffsetSmall:new qe(o,e.smallOffsetLineMaterial),label:new eo({view:s,attached:l,distance:0,geometry:{type:"segment",sampleLocation:"center",segment:this._labelSegment,callout:!1},fontSize:fe(c),textColor:u.clone(),backgroundColor:d.clone(),isDecoration:a})}),this._handles.add([S(()=>i.geometry,h=>{this.updateCameraDependentElements(s.state.camera,h,t.style),i.geometry!=null&&this._updateLines(i.geometry)},{...ot,equals:Ln}),S(()=>i.length,h=>this._updateLabelContent(h),ot)])}destroy(){this.destroyed=!0,this._handles=Un(this._handles);for(const e of this._visualElements.values())e.destroy()}get testInfo(){return{dimensionVisualElement:this._visualElements.dimension,label:this._visualElements.label}}_updateLines(e){const t=Ai(qc,bt.Start,e.directSegment,e.dimensionSegment),i=Ai(Uc,bt.End,e.directSegment,e.dimensionSegment),s=this._visualElements;s.marker.setGeometryFromSegment(e.dimensionSegment,e.primaryOffsetAxis),s.dimension.setGeometryFromSegment(e.dimensionSegment),s.startOffset.setGeometryFromSegment(t),s.endOffset.setGeometryFromSegment(i),s.dimensionSmall.setGeometryFromSegment(e.dimensionSegment),s.startOffsetSmall.setGeometryFromSegment(t),s.endOffsetSmall.setGeometryFromSegment(i)}updateCameraDependentElements(e,t,i){const s=this._visualElements;if(t==null){for(const v of s.values())v.visible=!1;return}const r=e.computeScreenPixelSizeAt(t.dimensionSegment.eval(.5,Wc)),a=Ao(t,r),l=a<(fe(i.lineSize)*Xo)**2,o=!l;s.marker.visible=o,s.dimension.visible=o,s.startOffset.visible=o,s.endOffset.visible=o,s.dimensionSmall.visible=l,s.startOffsetSmall.visible=l,s.endOffsetSmall.visible=l;const c=fe(i.fontSize)*Zo,{label:u}=s;if(u.visible=a>=c**2,!u.visible)return;const{dimensionSegment:d,primaryOffsetAxis:h}=t,{offset:m}=this.computation.dimension,_=(Math.sign(m)>=0?1:-1)*this._labelOffsetPx(i)*r;Eo(this._labelSegment,d,h,_),u.updateLabelPosition()}updateLabelStyle(e){const{label:t}=this._visualElements;t.fontSize=fe(e.fontSize),t.textColor=e.textColor,t.backgroundColor=e.textBackgroundColor}updateUnitsMessages(e){this._messages=e;const{length:t}=this.computation;this._updateLabelContent(t)}_updateLabelContent(e){const{label:t}=this._visualElements;e!=null&&this._messages!=null?t.text=to(this._messages,e,e.unit):t.text=""}_labelOffsetPx(e){return 1.5*fe(e.fontSize)+Wo+fe(e.lineSize/2)}};const qc=new Ye,Uc=new Ye,Wc=g();class Zc{constructor(e){this.marker=e.marker,this.dimension=e.dimension,this.startOffset=e.startOffset,this.endOffset=e.endOffset,this.dimensionSmall=e.dimensionSmall,this.startOffsetSmall=e.startOffsetSmall,this.endOffsetSmall=e.endOffsetSmall,this.label=e.label}values(){return[this.marker,this.dimension,this.startOffset,this.endOffset,this.dimensionSmall,this.startOffsetSmall,this.endOffsetSmall,this.label]}}let Me=class extends K{get analysis(){return this.analysisViewData.analysis}get visible(){return this.analysisViewData.visible}constructor(n){super(n),this.loadingMessages=!1,this._messages=null}initialize(){const n=this.isDecoration;this._markerMaterial=new bs({width:1,anchor:qa.Tip,color:ht,placement:"begin-end",worldSpace:!0,hideOnShortSegments:!0,hasTip:!0,renderOccluded:x.OccludeAndTransparent,markerPrimitive:"triangle",isDecoration:n}),this._dimensionLineMaterial=new ge({width:1,color:ht,renderOccluded:x.OccludeAndTransparent,markerParameters:this._markerMaterial.parameters,isDecoration:n}),this._offsetLineMaterial=new ge({width:1,color:ht,renderOccluded:x.OccludeAndTransparent,stipplePattern:Xt(5),isDecoration:n}),this._smallDimensionLineMaterial=new ge({width:1,color:ht,renderOccluded:x.OccludeAndTransparent,isDecoration:n}),this._smallOffsetLineMaterial=new ge({width:1,color:ht,renderOccluded:x.OccludeAndTransparent,stipplePattern:Xt(5),isDecoration:n});for(const t of this._lineMaterials())this.view._stage.add(t),this.addHandles(jn(()=>{var i;(i=this.view._stage)==null||i.remove(t)}));const e=on(()=>this.analysisViewData.computations,({computation:t})=>this._createVisualization(t));this._dimensionVisualizations=e,this.addHandles([re(e),S(()=>X.toUnitRGBA(this.analysis.style.color),t=>{for(const i of this._lineMaterials())i.setParameters({color:t})},F),S(()=>this.analysis.style.lineSize,t=>{const i=fe(t);this._markerMaterial.setParameters({width:i*Fs}),this._dimensionLineMaterial.setParameters({width:i,markerParameters:this._markerMaterial.parameters});const s=Math.max(i*Uo,1);this._offsetLineMaterial.setParameters({width:s})},F),S(()=>({camera:this.view.state.camera,style:Bc(this.analysis)}),({camera:t,style:i})=>{for(const{visualization:s}of this._dimensionVisualizations)s.updateCameraDependentElements(t,s.computation.geometry,i),s.updateLabelStyle(i)}),S(()=>this.visible,t=>{for(const{visualization:i}of this._dimensionVisualizations)i.visible=t})]),this.addHandles([Ua(()=>this._updateMessageBundle()),Wn(()=>!this.loadingMessages,()=>{for(const{visualization:t}of this._dimensionVisualizations)t.updateUnitsMessages(this._messages)},Pt)]),this._updateMessageBundle()}get testInfo(){return{visualizations:this._dimensionVisualizations.items.map(({visualization:n})=>n),disablePartialOcclusion:()=>{for(const n of this._lineMaterials())n.setParameters({renderOccluded:x.Occlude})}}}_createVisualization(n){const e=new jc({analysis:this.analysis,computation:n,view:this.view,visible:this.visible,markerMaterial:this._markerMaterial,dimensionLineMaterial:this._dimensionLineMaterial,offsetLineMaterial:this._offsetLineMaterial,smallDimensionLineMaterial:this._smallDimensionLineMaterial,smallOffsetLineMaterial:this._smallOffsetLineMaterial,messages:this._messages,isDecoration:this.isDecoration});return{visualization:e,remove:()=>e.destroy()}}_lineMaterials(){return[this._markerMaterial,this._dimensionLineMaterial,this._offsetLineMaterial,this._smallDimensionLineMaterial,this._smallOffsetLineMaterial]}async _updateMessageBundle(){this.loadingMessages=!0;try{this._messages=await Wa("esri/core/t9n/Units")}finally{this.loadingMessages=!1}}};function Bc(n){const{fontSize:e,lineSize:t,textColor:i,textBackgroundColor:s}=n.style;return{fontSize:e,lineSize:t,textBackgroundColor:s.clone(),textColor:i.clone()}}p([f({constructOnly:!0})],Me.prototype,"analysisViewData",void 0),p([f({constructOnly:!0,nonNullable:!0})],Me.prototype,"view",void 0),p([f({constructOnly:!0})],Me.prototype,"isDecoration",void 0),p([f()],Me.prototype,"analysis",null),p([f()],Me.prototype,"visible",null),p([f()],Me.prototype,"loadingMessages",void 0),Me=p([z("esri.views.3d.analysis.Dimension.DimensionVisualization")],Me);let gt=class extends K{constructor(n){super(n),this.dimension=null,this.length=null}};p([f({constructOnly:!0,nonNullable:!0})],gt.prototype,"dimension",void 0),p([f()],gt.prototype,"length",void 0),gt=p([z("esri.views.3d.analysis.LengthDimensionResult")],gt);const Yc=gt;let Z=class extends K{constructor(n){super(n),this.geometry=null,this.unconstrainedGeometry=null,this.elevationAlignedStartPoint=null,this.elevationAlignedEndPoint=null}normalizeCtorArgs(n){const{dimension:e,...t}=n;return{result:new Yc({dimension:e}),...t}}initialize(){this.addHandles([S(()=>this.dimension.startPoint,n=>this.elevationAlignedStartPoint=this.projectAndAlignPoint(n),F),S(()=>this.dimension.endPoint,n=>this.elevationAlignedEndPoint=this.projectAndAlignPoint(n),F)])}get dimension(){return this.result.dimension}get length(){return this.result.length}};p([f({constructOnly:!0,nonNullable:!0})],Z.prototype,"result",void 0),p([f({constructOnly:!0,nonNullable:!0})],Z.prototype,"projectAndAlignPoint",void 0),p([f()],Z.prototype,"dimension",null),p([f()],Z.prototype,"length",null),p([f()],Z.prototype,"geometry",void 0),p([f()],Z.prototype,"unconstrainedGeometry",void 0),p([f()],Z.prototype,"elevationAlignedStartPoint",void 0),p([f()],Z.prototype,"elevationAlignedEndPoint",void 0),p([f()],Z.prototype,"preConstraintProperties",void 0),p([f()],Z.prototype,"previousConstraint",void 0),Z=p([z("esri.views.3d.analysis.LengthDimensionComputation")],Z);const Xc=n=>{let e=class extends n{constructor(...t){super(...t),this.analysis=null,this.tool=null,this.selectedDimension=null,this.interactive=!1,this.visible=null}get results(){return new Et}createLengthDimensions(t){throw new Error("Method not implemented.")}};return p([f({constructOnly:!0})],e.prototype,"view",void 0),p([f({constructOnly:!0,nonNullable:!0})],e.prototype,"analysis",void 0),p([f()],e.prototype,"tool",void 0),p([f({readOnly:!0})],e.prototype,"results",null),p([f()],e.prototype,"selectedDimension",void 0),p([f()],e.prototype,"interactive",void 0),p([f()],e.prototype,"visible",void 0),e=p([z("esri.views.analysis.DimensionAnalysisView")],e),e};let j=class extends Xc(Za(K)){constructor(n){super(n),this.type="dimension-view-3d",this.tool=null,this.selectedDimension=null,this._dimensionsToComputations=new Map,this._placementTask=null,this._projectAndAlignPoint=null}initialize(){this._projectAndAlignPoint=e=>{if(e==null)return null;const{spatialReference:t,elevationProvider:i}=this.view,s=Ba(e,t,i);return s==null&&Ya(this.analysis,e.spatialReference,Gn.getLogger(this)),s};const n=on(()=>this.analysis.dimensions,e=>this._createComputation(e));this.computations=n,this.addHandles([ao(this,W),re(n)]),this._analysisVisualization=new Me({analysisViewData:this,view:this.view,isDecoration:!this.parent}),this._analysisController=new Ue({analysisViewData:this,view:this.view})}destroy(){this._placementTask=xt(this._placementTask),this._analysisVisualization=Un(this._analysisVisualization),oo(this)}get updating(){var n;return((n=this._analysisVisualization)==null?void 0:n.loadingMessages)??!1}get results(){return this.analysis.dimensions.map(n=>this._dimensionsToComputations.get(n).result)}get selectedComputation(){const{selectedDimension:n}=this;return n==null?null:this._dimensionsToComputations.get(n)}get testInfo(){return{visualization:this._analysisVisualization,controller:this._analysisController}}async createLengthDimensions(n){return this.selectedDimension=null,this._placementTask=xt(this._placementTask),this._placementTask=lo(this,n),this._placementTask.promise}_createComputation(n){const{_dimensionsToComputations:e}=this,t=new Z({dimension:n,projectAndAlignPoint:this._projectAndAlignPoint});return e.set(n,t),{computation:t,remove:()=>this._removeComputation(t)}}_removeComputation(n){const{dimension:e}=n;e===this.selectedDimension&&(this.selectedDimension=null),this._dimensionsToComputations.delete(e),n.destroy()}};p([f({readOnly:!0})],j.prototype,"type",void 0),p([f()],j.prototype,"tool",void 0),p([f()],j.prototype,"updating",null),p([f({readOnly:!0})],j.prototype,"results",null),p([f()],j.prototype,"computations",void 0),p([f()],j.prototype,"selectedDimension",void 0),p([f()],j.prototype,"selectedComputation",null),p([f()],j.prototype,"_analysisVisualization",void 0),p([f()],j.prototype,"_analysisController",void 0),p([f()],j.prototype,"_dimensionsToComputations",void 0),p([f()],j.prototype,"_placementTask",void 0),j=p([z("esri.views.3d.analysis.DimensionAnalysisView3D")],j);const Qc=j,Zu=Object.freeze(Object.defineProperty({__proto__:null,default:Qc},Symbol.toStringTag,{value:"Module"}));export{Zu as D,vu as E,Rl as R,mc as a,dt as b,Ge as c,Ll as d,gu as i,Su as j,ei as m,fi as n,fc as r,yl as t};
function __vite__mapDeps(indexes) {
  if (!__vite__mapDeps.viteFileDeps) {
    __vite__mapDeps.viteFileDeps = ["assets/FeatureServiceSnappingSource-fcg0Suuo.js","assets/index-3T8NnAdH.js","assets/index-Vh02goE1.css","assets/elevationInfoUtils-WwYDl0RG.js","assets/queryEngineUtils-lysQvCSX.js","assets/VertexSnappingCandidate-TSpu1EN-.js","assets/TileTreeDebugger-T2FianRj.js","assets/LineVisualElement-mrWDSgVw.js","assets/LengthDimension-Tri9o4Jy.js","assets/Segment-TeMlAb70.js","assets/unitFormatUtils-zKY0g_di.js","assets/ShadedColorMaterial.glsl-bM-6avW0.js","assets/Factory-qnF1klF8.js","assets/ImageMaterial.glsl-4yDSHPsM.js","assets/vec4f32-NvfHy9q7.js","assets/RightAngleQuadVisualElement-qdXyiV5z.js","assets/Laserlines.glsl-Wb-z-XSI.js","assets/EditGeometryOperations-DjI-3zXJ.js","assets/floorFilterUtils-zOdaZIyV.js","assets/dehydratedFeatureComparison-TL8HUJB8.js","assets/FeatureCollectionSnappingSource-bBpehqoS.js","assets/symbologySnappingCandidates-VKnTj9vj.js","assets/GraphicsSnappingSource-ju_o_2OH.js","assets/normalizeUtilsSync-tXwQi2o9.js","assets/FeatureStore-gS43Cdgh.js","assets/BoundsStore-DSYVvWPu.js","assets/PooledRBush-yvWXTK5L.js","assets/quickselect-X97ywmUd.js","assets/QueryEngine-QXCYjOy3.js","assets/WhereClause-rvxfqIBA.js","assets/TimeOnly-9DDBccWC.js","assets/json-v6EOeNTY.js","assets/QueryEngineCapabilities-PzVpW5yD.js","assets/utils-qIGSl3HI.js","assets/utils-6esXKgtb.js","assets/generateRendererUtils-OiKFgbvL.js","assets/optimizedFeatureQueryEngineAdapter-tByZWg6M.js","assets/SceneLayerSnappingSource-bEgtBvls.js"]
  }
  return indexes.map((i) => __vite__mapDeps.viteFileDeps[i])
}
